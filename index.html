<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CORE: ETERNAL</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="CORE">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        *, *::before, *::after { box-sizing: border-box; }

        :root {
            --theme-color: #00f7ff; 
            --theme-dim: #005f6b;
            --bg-color: #020205;
            --panel-bg: rgba(5, 10, 20, 0.65);
            --text: #e0f0ff;
            --accent: #ff0055;
            --gold: #ffd700;
            --rare: #b042ff;
            --unique: #00ff00;
            --ether: #ffffff;
            --god: #00ffff; /* çœŸåŒ–ç”¨ã‚«ãƒ©ãƒ¼ */
            --boost: #ff8800;
        }

        body {
            margin: 0; overflow: hidden; background-color: var(--bg-color); color: var(--text);
            font-family: 'Roboto Mono', monospace;
        }

        #bg-grid {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -2;
            background-image: 
                linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
            background-size: 40px 40px;
            pointer-events: none;
        }

        #bg-glow {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;
            background-color: var(--theme-color);
            opacity: 0;
            transition: none !important;
            pointer-events: none;
            mix-blend-mode: screen;
        }

        body.low-perf * {
            text-shadow: none !important;
            box-shadow: none !important;
            filter: none !important;
            backdrop-filter: none !important;
        }
        body.low-perf .sidebar, body.low-perf .phase-container, body.low-perf .modal-content {
            background: rgba(10, 15, 25, 0.95) !important;
        }
        body.no-blur .sidebar, body.no-blur .phase-container, body.no-blur .modal-content {
            backdrop-filter: none !important;
            background: rgba(10, 15, 25, 0.9) !important;
        }

        h1, h2, h3, .tech-font { 
            font-family: 'Orbitron', sans-serif; 
            letter-spacing: 1px; 
            text-shadow: 0 0 5px currentColor;
        }

        #particleCanvas {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 0; pointer-events: none;
            filter: blur(0.5px) contrast(1.2);
        }

        #game-layout {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: grid; grid-template-columns: 380px 1fr 380px; z-index: 10;
        }

        .sidebar {
            background: var(--panel-bg);
            border-right: 1px solid rgba(255,255,255,0.1); 
            border-left: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 0 30px rgba(0,0,0,0.8);
            display: flex; flex-direction: column; padding: 10px; 
            backdrop-filter: blur(10px);
            overflow: hidden;
            transition: border-color 1s ease;
            padding-bottom: 20px;
        }
        
        .scroll-area { 
            flex-grow: 1; overflow-y: auto; overflow-x: hidden; padding-right: 5px; 
            padding-bottom: 80px; 
            scrollbar-width: thin;
            scrollbar-color: var(--theme-dim) transparent;
        }

        #center-stage {
            position: relative; display: flex; flex-direction: column; align-items: center; justify-content: center;
            box-shadow: inset 0 0 50px rgba(0,0,0,0.8);
        }
        
        #header-stats { 
            position: absolute; top: 30px; text-align: center; width: 100%; pointer-events: none; 
            z-index: 20;
        }
        #score-display { 
            font-family: 'Orbitron'; 
            font-size: 2.5rem; /* 3remã‹ã‚‰å°‘ã—ç¸®å° */
            font-weight: 700; 
            color: #fff;
            text-shadow: 0 0 10px var(--theme-color), 0 0 20px var(--theme-color), 0 0 40px var(--theme-color);
            transition: text-shadow 1s;
            white-space: nowrap; /* æŠ˜ã‚Šè¿”ã—é˜²æ­¢ */
        }
        #mps-display { 
            color: var(--theme-color); font-size: 1.1rem; margin-top: 5px; transition: color 1s;
            text-shadow: 0 0 5px var(--theme-color);
        }
        
        #header-relic-display {
            color: var(--rare); font-size: 1.3rem; font-weight: bold; margin: 5px 0; 
            text-shadow: 0 0 10px var(--rare), 0 0 20px var(--rare); 
            font-family: 'Orbitron';
        }

        .phase-container {
            position: absolute; bottom: 50px;
            left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.6); 
            border: 1px solid var(--theme-color);
            box-shadow: 0 0 15px var(--theme-dim);
            border-radius: 4px; padding: 10px 20px; width: 60%; pointer-events: auto;
            text-align: center; z-index: 20;
            backdrop-filter: blur(5px);
        }
        #stage-badge {
            font-family: 'Orbitron'; font-size: 1rem; color: var(--theme-color);
            text-transform: uppercase; letter-spacing: 2px;
            margin-bottom: 8px; display: block;
            text-shadow: 0 0 5px var(--theme-color);
        }
        #stage-progress-bg { width: 100%; height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden; }
        #stage-progress-fill { 
            height: 100%; width: 0%; background: var(--theme-color); 
            transition: width 0.3s, background 1s; 
            box-shadow: 0 0 10px var(--theme-color);
        }
        #stage-req-text { font-size: 0.8rem; color: #ccc; margin-top: 6px; font-family: 'Orbitron'; }

        #reactor-wrapper {
            width: 280px; height: 280px; position: relative; cursor: pointer; pointer-events: auto;
            transition: transform 0.05s; z-index: 5; margin-bottom: 20px;
            display: flex; align-items: center; justify-content: center;
            filter: drop-shadow(0 0 15px var(--theme-color));
        }
        #reactor-wrapper:active { transform: scale(0.95); filter: drop-shadow(0 0 25px var(--theme-color)); }

        .r-layer {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            border-style: solid;
            transition: all 1s ease;
            box-shadow: 0 0 10px var(--theme-color), inset 0 0 10px var(--theme-dim);
        }
        
        .core-glow {
            background: var(--theme-color);
            box-shadow: 0 0 40px var(--theme-color), 0 0 80px var(--theme-color);
            opacity: 0.9;
            mix-blend-mode: screen;
        }

        @keyframes spin-cw { 100% { transform: translate(-50%, -50%) rotate(360deg); } }
        @keyframes spin-ccw { 100% { transform: translate(-50%, -50%) rotate(-360deg); } }
        @keyframes pulse { 0%, 100% { opacity: 0.7; transform: translate(-50%, -50%) scale(1); filter: brightness(1); } 50% { opacity: 1; transform: translate(-50%, -50%) scale(1.1); filter: brightness(1.5); } }

        .shape-c0 .L1 { width: 100%; height: 100%; border-width: 4px; border-color: var(--theme-color) transparent; border-radius: 50%; animation: spin-cw 8s linear infinite; }
        .shape-c0 .L2 { width: 80%; height: 80%; border-width: 2px; border-color: transparent var(--theme-color); border-radius: 50%; animation: spin-ccw 5s linear infinite; }
        .shape-c0 .L3 { width: 60%; height: 60%; border-width: 6px; border-color: var(--theme-dim); border-radius: 50%; border-style: dotted; animation: spin-cw 20s linear infinite;}
        .shape-c0 .L4 { width: 30%; height: 30%; border-radius: 50%; animation: pulse 2s ease-in-out infinite; }

        .shape-c1 .L1 { width: 100%; height: 100%; border: 2px dashed var(--theme-color); border-radius: 50%; animation: spin-cw 20s linear infinite; box-shadow: 0 0 10px var(--theme-dim); }
        .shape-c1 .L2 { width: 90%; height: 90%; border: 4px solid var(--theme-color); clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%); animation: spin-ccw 5s linear infinite; opacity: 0.8; }
        .shape-c1 .L3 { width: 70%; height: 70%; border: 1px solid var(--theme-color); background: linear-gradient(45deg, transparent 40%, var(--theme-dim) 50%, transparent 60%); animation: spin-cw 3s linear infinite; }
        .shape-c1 .L4 { width: 40%; height: 40%; background: var(--theme-color); clip-path: polygon(20% 0%, 80% 0%, 100% 20%, 100% 80%, 80% 100%, 20% 100%, 0% 80%, 0% 20%); animation: pulse 2s infinite; opacity: 0.8; }

        /* Phase 3: Void Gate (ç•°ãªã‚‹å¤ªã•ã®å††å¼§ã¨é‡ãªã‚Š) */
        .shape-c2 .L1 { width: 100%; height: 100%; border: 6px solid transparent; border-top: 6px solid var(--theme-color); border-bottom: 6px solid var(--theme-color); border-radius: 50%; animation: spin-cw 4s linear infinite; box-shadow: 0 0 15px var(--theme-color); }
        .shape-c2 .L2 { width: 85%; height: 85%; border: 2px solid var(--theme-dim); border-radius: 50%; border-left: 10px solid var(--theme-color); border-right: 10px solid var(--theme-color); animation: spin-ccw 8s ease-in-out infinite; }
        .shape-c2 .L3 { width: 60%; height: 60%; border: 1px dashed var(--theme-color); border-radius: 50%; animation: spin-cw 10s linear infinite; }
        .shape-c2 .L4 { width: 20%; height: 20%; background: var(--theme-color); border-radius: 50%; box-shadow: 0 0 20px var(--theme-color); animation: pulse 0.5s infinite alternate; }

        /* Phase 4: Antimatter Shard (é‹­åˆ©ãªç ´ç‰‡ã¨é«˜é€Ÿå›è»¢) */
        .shape-c3 .L1 { width: 100%; height: 100%; border: 1px solid var(--theme-color); clip-path: polygon(50% 0%, 60% 40%, 100% 50%, 60% 60%, 50% 100%, 40% 60%, 0% 50%, 40% 40%); animation: spin-cw 15s linear infinite; background: rgba(255,255,255,0.02); }
        .shape-c3 .L2 { 
            width: 100%; height: 100%; /* ã‚³ãƒ³ãƒ†ãƒŠã„ã£ã±ã„ã«åºƒã’ã¦ä¸­å¿ƒåº§æ¨™(50%)ã‚’åˆã‚ã›ã‚‹ */
            background: var(--theme-color); 
            opacity: 1; /* ç·šã‚’ç´°ãã—ãŸåˆ†ã€ã‚¯ãƒƒã‚­ãƒªè¦‹ãˆã‚‹ã‚ˆã†ã«ä¸é€æ˜åº¦ã‚¢ãƒƒãƒ— */
            /* é‡å¿ƒ(50% 50%)ã‚’ä¸­å¿ƒã¨ã—ãŸæ­£ä¸‰è§’å½¢ã®åº§æ¨™ã€‚
               å¤–å´åŠå¾„: 48%, å†…å´åŠå¾„: 47% (å·®åˆ†1%ã§æ¥µç´°ãƒ©ã‚¤ãƒ³ã‚’å®Ÿç¾)
            */
            clip-path: polygon(
                /* å¤–å´ã®ä¸‰è§’å½¢ */
                50% 2%, 91.6% 74%, 8.4% 74%, 50% 2%, 
                /* å†…å´ã®ä¸‰è§’å½¢ (é ‚ç‚¹ã®é †åºã‚’é€†ã«ã—ã¦ç©´ã‚’ã‚ã‘ã‚‹) */
                50% 3.5%, 9.7% 73.2%, 90.3% 73.2%, 50% 3.5%
            );
            animation: spin-cw 8s linear infinite; 
            filter: drop-shadow(0 0 5px var(--theme-color)); 
        }
        .shape-c3 .L3 { 
            width: 100%; height: 100%; 
            background: var(--theme-color); 
            opacity: 1;
            /* L2ã¨åŒã˜åº§æ¨™ */
            clip-path: polygon(
                50% 2%, 91.6% 74%, 8.4% 74%, 50% 2%, 
                50% 3.5%, 9.7% 73.2%, 90.3% 73.2%, 50% 3.5%
            );
            animation: spin-ccw 8s linear infinite; 
            filter: drop-shadow(0 0 5px var(--theme-color));
        }
        .shape-c3 .L4 { width: 30%; height: 30%; border: 2px solid #fff; transform: rotate(45deg); animation: pulse 0.2s infinite; box-shadow: 0 0 30px var(--theme-color); background: var(--theme-color); }

        /* Phase 5: Divine Tech (é­”æ³•é™£ã®ã‚ˆã†ãªå¹¾ä½•å­¦æ¨¡æ§˜) */
        .shape-c4 .L1 { width: 100%; height: 100%; border: 1px solid var(--theme-dim); border-radius: 50%; box-shadow: inset 0 0 20px var(--theme-color); animation: spin-cw 60s linear infinite; }
        .shape-c4 .L2 { width: 100%; height: 100%; border: 2px solid var(--theme-color); clip-path: polygon(0% 15%, 15% 15%, 15% 0%, 85% 0%, 85% 15%, 100% 15%, 100% 85%, 85% 85%, 85% 100%, 15% 100%, 15% 85%, 0% 85%); animation: spin-ccw 20s linear infinite; }
        .shape-c4 .L3 { 
            width: 65%; height: 65%; 
            border: 2px solid var(--theme-color); 
            background: radial-gradient(circle, transparent 30%, rgba(0, 247, 255, 0.2) 40%, transparent 60%);
            /* è§’ã‚’è½ã¨ã—ãŸå…«è§’å½¢ã®ã‚ˆã†ãªè¤‡é›‘ãªå½¢çŠ¶ */
            clip-path: polygon(
                30% 0%, 70% 0%, 100% 30%, 100% 70%, 
                70% 100%, 30% 100%, 0% 70%, 0% 30%
            );
            /* â˜…ä¿®æ­£ç‚¹: translate(-50%, -50%) ã‚’æ˜ç¤ºã—ã¦å¸¸ã«ä¸­å¿ƒã«å›ºå®š */
            transform: translate(-50%, -50%);
            animation: spin-cw 12s linear infinite;
            box-shadow: 0 0 15px var(--theme-color), inset 0 0 10px var(--theme-color);
        }
        .shape-c4 .L4 { width: 40%; height: 40%; border: 1px solid #fff; border-radius: 50%; box-shadow: 0 0 10px var(--theme-color); animation: pulse 4s infinite; background: radial-gradient(circle, var(--theme-color), transparent); }

        /* Phase 6: Cyber HUD (ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚¹ã‚³ãƒ¼ãƒ—) */
        .shape-c5 .L1 { width: 100%; height: 100%; border: 2px solid var(--theme-color); border-radius: 50%; clip-path: polygon(0% 45%, 10% 45%, 10% 55%, 0% 55%, 0% 100%, 100% 100%, 100% 55%, 90% 55%, 90% 45%, 100% 45%, 100% 0%, 0% 0%); animation: spin-cw 10s ease-in-out infinite; }
        .shape-c5 .L2 { width: 80%; height: 80%; border: 1px dashed var(--theme-color); border-radius: 50%; animation: spin-ccw 20s linear infinite; }
        .shape-c5 .L3 { width: 90%; height: 90%; border-top: 20px solid transparent; border-bottom: 20px solid transparent; border-left: 4px solid var(--theme-color); border-right: 4px solid var(--theme-color); border-radius: 50%; animation: spin-cw 2s cubic-bezier(0.68, -0.55, 0.27, 1.55) infinite; }
        .shape-c5 .L4 { width: 10%; height: 10%; background: #fff; border-radius: 50%; box-shadow: 0 0 20px #fff; animation: pulse 1s infinite; }

        /* Phase 7: Plasma Reactor (ã‚¨ãƒãƒ«ã‚®ãƒ¼å……å¡«) */
        .shape-c6 .L1 { width: 100%; height: 100%; border-radius: 50%; border: 2px dashed var(--theme-color); animation: spin-cw 20s linear infinite; opacity: 0.3; }
        .shape-c6 .L2 { 
            width: 100%; height: 100%; 
            border-radius: 50%;
            
            background: 
                /* 1å±¤ç›®ï¼ˆæ‰‹å‰ï¼‰: ãƒªãƒ³ã‚°çŠ¶ã®ãƒœãƒ‡ã‚£ */
                /* ãƒœãƒ‡ã‚£ã®å¹…ã‚’ç‹­ã‚(70%~82%)ã€å¤–å´ã®æ­¯ã®ãŸã‚ã®ã‚¹ãƒšãƒ¼ã‚¹(82%~100%)ã‚’åºƒãç¢ºä¿ã—ã¾ã—ãŸ */
                radial-gradient(transparent 70%, var(--theme-color) 71%, var(--theme-color) 82%, transparent 83%),
                
                /* 2å±¤ç›®ï¼ˆå¥¥ï¼‰: æ­¯è»Šãƒ‘ã‚¿ãƒ¼ãƒ³ (æ‰‡å½¢ã®ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³) */
                conic-gradient(
                    from 0deg,
                    var(--theme-color) 0deg 10deg, transparent 10deg 30deg,
                    var(--theme-color) 30deg 40deg, transparent 40deg 60deg,
                    var(--theme-color) 60deg 70deg, transparent 70deg 90deg,
                    var(--theme-color) 90deg 100deg, transparent 100deg 120deg,
                    var(--theme-color) 120deg 130deg, transparent 130deg 150deg,
                    var(--theme-color) 150deg 160deg, transparent 160deg 180deg,
                    var(--theme-color) 180deg 190deg, transparent 190deg 210deg,
                    var(--theme-color) 210deg 220deg, transparent 220deg 240deg,
                    var(--theme-color) 240deg 250deg, transparent 250deg 270deg,
                    var(--theme-color) 270deg 280deg, transparent 280deg 300deg,
                    var(--theme-color) 300deg 310deg, transparent 310deg 330deg,
                    var(--theme-color) 330deg 340deg, transparent 340deg 360deg
                );
            
            /* ãƒã‚¹ã‚¯: ä¸­å¿ƒã®ç©´ã‚’åºƒã’(60%)ã€å†…å´ã®æ­¯ã‚‚çŸ­ãé‹­ãè¦‹ã›ã‚‹ */
            -webkit-mask: radial-gradient(transparent 60%, black 61%);
            mask: radial-gradient(transparent 60%, black 61%);
            
            /* å‹•ã: é‡åšãªå›è»¢ */
            animation: spin-ccw 4s cubic-bezier(0.68, -0.6, 0.32, 1.6) infinite;
            
            filter: drop-shadow(0 0 5px var(--theme-color));
        }
        .shape-c6 .L3 { width: 70%; height: 70%; background: conic-gradient(from 0deg, transparent, var(--theme-dim), transparent); border-radius: 50%; animation: spin-cw 1s linear infinite; opacity: 0.8; }
        .shape-c6 .L4 { width: 50%; height: 50%; background: radial-gradient(circle, #fff, var(--theme-color)); border-radius: 50%; animation: pulse 0.3s infinite; filter: blur(2px); }

        /* Phase 8: Singularity (ãƒ–ãƒ©ãƒƒã‚¯ãƒ›ãƒ¼ãƒ«ã¨é™ç€å††ç›¤) */
        .shape-c7 .L1 { width: 110%; height: 30%; border: 2px solid var(--theme-color); border-radius: 50%; animation: spin-cw 8s linear infinite; }
        .shape-c7 .L2 { width: 30%; height: 110%; border: 2px solid var(--theme-color); border-radius: 50%; animation: spin-cw 8s linear infinite; }
        .shape-c7 .L3 { width: 80%; height: 80%; border: 10px double var(--theme-dim); border-radius: 50%; animation: spin-ccw 20s linear infinite; box-shadow: inset 0 0 20px var(--theme-color); }
        .shape-c7 .L4 { width: 25%; height: 25%; background: #000; border: 2px solid #fff; border-radius: 50%; box-shadow: 0 0 30px var(--theme-color); animation: pulse 2s infinite; }

        /* Phase 9: Angelic Ring (ä¿®æ­£ç‰ˆï¼šã‚»ãƒ©ãƒ•ã‚£ãƒ ãƒ»ã‚¸ã‚ªãƒ¡ãƒˆãƒª) */
        
        /* L1: å¤–å‘¨ã®çµç•Œãƒªãƒ³ã‚° (é€”åˆ‡ã‚ŒãŸå…‰ã®è¼ª) */
        .shape-c8 .L1 { 
            width: 100%; height: 100%; 
            border: 2px solid var(--theme-color); 
            border-radius: 50%; 
            /* ä¸Šä¸‹å·¦å³ã®ä¸€éƒ¨ã‚’é€æ˜ã«ã—ã¦ã€åˆ‡ã‚Œè¾¼ã¿ã‚’å…¥ã‚Œã‚‹ */
            border-top-color: transparent;
            border-bottom-color: transparent;
            box-shadow: 0 0 15px var(--theme-color), inset 0 0 15px var(--theme-color); 
            animation: spin-cw 12s linear infinite; 
        }

        /* L2: åäºŒæ–¹å‘ã¸ä¼¸ã³ã‚‹å…‰ã®æ§ï¼ˆå¹¾ä½•å­¦çš„ã‚¹ãƒ‘ã‚¤ã‚¯ï¼‰ */
        .shape-c8 .L2 { 
            width: 95%; height: 95%; 
            background: conic-gradient(from 0deg, 
                var(--theme-color) 0deg 2deg, transparent 2deg 30deg,
                var(--theme-color) 30deg 32deg, transparent 32deg 60deg,
                var(--theme-color) 60deg 62deg, transparent 62deg 90deg,
                var(--theme-color) 90deg 92deg, transparent 92deg 120deg,
                var(--theme-color) 120deg 122deg, transparent 122deg 150deg,
                var(--theme-color) 150deg 152deg, transparent 152deg 180deg,
                var(--theme-color) 180deg 182deg, transparent 182deg 210deg,
                var(--theme-color) 210deg 212deg, transparent 212deg 240deg,
                var(--theme-color) 240deg 242deg, transparent 242deg 270deg,
                var(--theme-color) 270deg 272deg, transparent 272deg 300deg,
                var(--theme-color) 300deg 302deg, transparent 302deg 330deg,
                var(--theme-color) 330deg 332deg, transparent 332deg 360deg
            );
            /* ä¸­å¿ƒã‚’å¤§ãããã‚ŠæŠœã„ã¦ãƒªãƒ³ã‚°çŠ¶ã«ã™ã‚‹ */
            -webkit-mask: radial-gradient(transparent 65%, black 66%);
            mask: radial-gradient(transparent 65%, black 66%);
            animation: spin-ccw 20s linear infinite;
            filter: drop-shadow(0 0 8px var(--theme-color));
            opacity: 0.8;
        }

        /* L3: å†…éƒ¨ã®å¹¾ä½•å­¦æ¨¡æ§˜ (å…«è§’å½¢ã¨å†…éƒ¨å††ã®èåˆ) */
        .shape-c8 .L3 { 
            width: 65%; height: 65%; 
            border: 2px solid var(--theme-color);
            /* å…«è§’å½¢ï¼ˆã‚ªã‚¯ã‚¿ã‚´ãƒ³ï¼‰ã«åˆ‡ã‚ŠæŠœã */
            clip-path: polygon(30% 0%, 70% 0%, 100% 30%, 100% 70%, 70% 100%, 30% 100%, 0% 70%, 0% 30%);
            /* å†…éƒ¨ã«ã†ã£ã™ã‚‰ã¨é­”æ³•é™£ã®ã‚ˆã†ãªå††ã‚’æã */
            background: radial-gradient(transparent 55%, var(--theme-color) 56%, transparent 58%);
            animation: spin-cw 6s ease-in-out infinite;
            box-shadow: 0 0 15px var(--theme-color);
        }

        /* L4: ç¥æ ¸ (Core) - å¼·çƒˆãªè¼ã */
        .shape-c8 .L4 { 
            width: 25%; height: 25%; 
            background: #fff; 
            border-radius: 50%; 
            box-shadow: 0 0 60px #fff, 0 0 20px var(--theme-color); 
            animation: pulse 1.5s infinite; 
        }

        /* Phase 10: Eternal Void (é›†å¤§æˆï¼šã‚¢ãƒã‚«ãƒªãƒ—ã‚¹ãƒ»ã‚³ã‚¢) - å…¨è¦ç´ ã®æ··æ²Œèåˆ */
        
        /* L1: æœ€å¤–å±¤ - å´©å£Šã™ã‚‹çµç•Œãƒªãƒ³ã‚°ã¨é­”æ³•é™£ã®æ®‹éª¸ */
        .shape-c9 .L1 {
            width: 100%; height: 100%;
            border: 2px dashed var(--theme-color);
            border-radius: 50%;
            /* è¤‡æ•°ã®ãƒªãƒ³ã‚°ãŒé‡ãªã‚Šã€ä¸€éƒ¨ãŒæ¬ ã‘ã¦ã„ã‚‹è¤‡é›‘ãªå±¤ */
            background: 
                radial-gradient(transparent 60%, var(--theme-dim) 61%, var(--theme-dim) 64%, transparent 65%), /* å†…å´ã®è–„ã„ãƒªãƒ³ã‚° */
                conic-gradient(from 0deg, transparent 0deg 240deg, var(--theme-color) 240deg 360deg); /* éƒ¨åˆ†çš„ãªå…‰ã®å¼§ */
            mask: radial-gradient(transparent 58%, black 59%);
            -webkit-mask: radial-gradient(transparent 58%, black 59%);
            animation: spin-cw 30s linear infinite; /* ã‚†ã£ãã‚Šã¨ã—ãŸé›„å¤§ãªå›è»¢ */
            box-shadow: 0 0 40px var(--theme-dim), inset 0 0 20px var(--theme-dim);
            filter: drop-shadow(0 0 15px var(--theme-color));
        }

        /* L2: å¤–å±¤ - é«˜é€Ÿå›è»¢ã™ã‚‹å…‰åˆƒã®åµ (æ‰‹è£å‰£è¦ç´ ã®å¼·åŒ–ç‰ˆ) */
        .shape-c9 .L2 {
            width: 88%; height: 88%;
            /* é‹­åˆ©ãªè¤‡æ•°ã®åˆƒãŒå›è»¢ã™ã‚‹ã‚¤ãƒ¡ãƒ¼ã‚¸ã®ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ */
            background: conic-gradient(
                from 0deg,
                var(--theme-color) 0deg 2deg, transparent 2deg 30deg, /* ç´°ãé‹­ã„åˆƒ */
                var(--theme-color) 30deg 35deg, transparent 35deg 60deg, /* å°‘ã—å¤ªã„åˆƒ */
                var(--theme-color) 60deg 62deg, transparent 62deg 90deg,
                var(--theme-color) 90deg 95deg, transparent 95deg 120deg,
                var(--theme-color) 120deg 122deg, transparent 122deg 150deg,
                var(--theme-color) 150deg 155deg, transparent 155deg 180deg,
                var(--theme-color) 180deg 182deg, transparent 182deg 210deg,
                var(--theme-color) 210deg 215deg, transparent 215deg 240deg,
                var(--theme-color) 240deg 242deg, transparent 242deg 270deg,
                var(--theme-color) 270deg 275deg, transparent 275deg 300deg,
                var(--theme-color) 300deg 302deg, transparent 302deg 330deg,
                var(--theme-color) 330deg 335deg, transparent 335deg 360deg
            );
            /* è¤‡é›‘ãªå¤šè§’å½¢ã§åˆ‡ã‚ŠæŠœã„ã¦æ”»æ’ƒçš„ãªãƒ•ã‚©ãƒ«ãƒ ã« */
            clip-path: polygon(50% 0%, 65% 35%, 100% 50%, 65% 65%, 50% 100%, 35% 65%, 0% 50%, 35% 35%);
            animation: spin-ccw 2.5s linear infinite; /* é«˜é€Ÿé€†å›è»¢ */
            opacity: 0.9;
            filter: drop-shadow(0 0 10px var(--theme-color));
        }

        /* L3: ä¸­å±¤ - é‡åšãªæ©Ÿæ¢°æ§‹é€ ã¨æ­¯è»Š (ãƒ¡ã‚«ãƒ‹ã‚«ãƒ«è¦ç´ ã®èåˆ) */
        .shape-c9 .L3 {
            width: 72%; height: 72%;
            border-radius: 50%;
            /* è¤‡é›‘ãªæ­¯è»Šã¨æ©Ÿæ¢°çš„ãªãƒ‘ã‚¿ãƒ¼ãƒ³ */
            background: 
                radial-gradient(transparent 35%, var(--theme-dim) 36%, var(--theme-color) 50%, transparent 51%), /* ãƒœãƒ‡ã‚£ */
                conic-gradient( /* æ­¯ */
                    from 15deg, 
                    var(--theme-dim) 0deg 10deg, transparent 10deg 30deg, 
                    var(--theme-dim) 30deg 40deg, transparent 40deg 60deg,
                    var(--theme-dim) 60deg 70deg, transparent 70deg 90deg,
                    var(--theme-dim) 90deg 100deg, transparent 100deg 120deg,
                    var(--theme-dim) 120deg 130deg, transparent 130deg 150deg,
                    var(--theme-dim) 150deg 160deg, transparent 160deg 180deg,
                    var(--theme-dim) 180deg 190deg, transparent 190deg 210deg,
                    var(--theme-dim) 210deg 220deg, transparent 220deg 240deg,
                    var(--theme-dim) 240deg 250deg, transparent 250deg 270deg,
                    var(--theme-dim) 270deg 280deg, transparent 280deg 300deg,
                    var(--theme-dim) 300deg 310deg, transparent 310deg 330deg,
                    var(--theme-dim) 330deg 340deg, transparent 340deg 360deg
                );
            mask: radial-gradient(transparent 28%, black 29%);
            -webkit-mask: radial-gradient(transparent 28%, black 29%);
            animation: spin-cw 7s cubic-bezier(0.7, -0.5, 0.3, 1.5) infinite; /* é‡é‡æ„Ÿã®ã‚ã‚‹å¼¾æ€§å›è»¢ */
            filter: drop-shadow(0 0 8px var(--theme-dim));
            opacity: 0.8;
        }

        /* L4: å†…å±¤ - èåˆã™ã‚‹å¹¾ä½•å­¦ã‚³ã‚¢ (è¤‡æ•°ã®å½¢çŠ¶ãŒé‡ãªã‚Šåˆã†) */
        .shape-c9 .L4 {
            width: 50%; height: 50%;
            background: linear-gradient(45deg, var(--theme-color), #fff);
            /* å…­è§’å½¢ã€åå­—ã€è±å½¢ãŒèåˆã—ãŸã‚ˆã†ãªè¤‡é›‘ãªã‚¯ãƒªã‚¹ã‚¿ãƒ«å½¢çŠ¶ */
            clip-path: polygon(
                50% 0%, 80% 20%, 100% 50%, 80% 80%, 
                50% 100%, 20% 80%, 0% 50%, 20% 20%,
                50% 10%, 90% 50%, 50% 90%, 10% 50% /* å†…éƒ¨ã®åå­—ãƒ©ã‚¤ãƒ³ */
            );
            animation: spin-ccw 5s linear infinite, pulse 1.2s ease-in-out infinite alternate;
            opacity: 0.95;
            box-shadow: 0 0 30px var(--theme-color), inset 0 0 30px #fff;
        }

        /* L5: ä¸­å¿ƒæ ¸ - çµ‚ç„‰ã®ç‰¹ç•°ç‚¹ (æ–°è¦è¿½åŠ ãƒ¬ã‚¤ãƒ¤ãƒ¼) */
        .shape-c9 .L5 {
            position: absolute; /* ä¸­å¤®ã«é…ç½® */
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 18%; height: 18%;
            background: #fff; /* ç´”ç™½ã®ã‚¨ãƒãƒ«ã‚®ãƒ¼ä½“ */
            border-radius: 50%;
            /* å¼·çƒˆãªç™ºå…‰ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ */
            box-shadow: 
                0 0 60px #fff,
                0 0 120px var(--theme-color),
                0 0 200px var(--theme-color),
                inset 0 0 30px var(--theme-color);
            /* æ¿€ã—ã„æ˜æ»…ã¨å›è»¢ */
            animation: pulse 0.2s ease-in-out infinite alternate, spin-cw 0.5s linear infinite;
            z-index: 10; /* æœ€å‰é¢ã«è¡¨ç¤º */
        }

        /* Phase 11: Cosmic Horror (ä¿®æ­£ç‰ˆV3ï¼šé€™ã„ã‚ˆã‚‹ä¾µé£Ÿã¨è™šç„¡ã®ç‰åº§) */

        /* æ–°è¦ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼šé€™ã„ã‚ˆã‚‹ã‚ˆã†ã«ã‚†ã£ãã‚Šã¨æ‹¡å¤§ç¸®å°ãƒ»å›è»¢ã™ã‚‹å‹•ã */
        @keyframes creep-grow {
            0% { transform: translate(-50%, -50%) scale(1) rotate(0deg); border-radius: 40% 60% 70% 30% / 40% 50% 60% 50%; }
            50% { transform: translate(-50%, -50%) scale(1.4) rotate(180deg); border-radius: 60% 40% 30% 70% / 60% 30% 70% 40%; }
            100% { transform: translate(-50%, -50%) scale(1.2) rotate(360deg); border-radius: 50% 50% 40% 60% / 50% 40% 60% 50%;}
        }
        /* æ ¸ã®æ­ªã¿ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        @keyframes core-morph {
            0% { border-radius: 50% 50% 50% 50% / 50% 50% 50% 50%; }
            33% { border-radius: 70% 40% 30% 80% / 70% 30% 80% 40%; }
            66% { border-radius: 40% 70% 80% 30% / 30% 70% 40% 80%; }
            100% { border-radius: 50% 50% 50% 50% / 50% 50% 50% 50%; }
        }
        /* æ™‚ç©ºã®è£‚ã‘ã‚ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        @keyframes core-morphs {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }
        /* è§¦æ‰‹ç”¨ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼šè»Ÿä½“å‹•ç‰©ã®ã‚ˆã†ãªæœ‰æ©Ÿçš„ãªå‹•ã */
        @keyframes slime-writhe {
            0% { transform: translate(-50%, -50%) rotate(0deg) scale(1); }
            25% { transform: translate(-50%, -50%) rotate(10deg) scale(1.05, 0.95); }
            50% { transform: translate(-50%, -50%) rotate(0deg) scale(0.95, 1.05); }
            75% { transform: translate(-50%, -50%) rotate(-10deg) scale(1.05, 0.95); }
            100% { transform: translate(-50%, -50%) rotate(0deg) scale(1); }
        }
        
        /* L1: ã€æœ€é‡è¦ã€‘ç”»é¢å…¨ä½“ã‚’ä¾µé£Ÿã—ã€ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã«è¦†ã„ã‹ã¶ã•ã‚‹å·¨å¤§ãªè§¦æ‰‹ã®å½± */
        .shape-c10 .L1 { 
            position: fixed; /* ãƒªã‚¢ã‚¯ã‚¿ãƒ¼ã®æ ã‚’ç„¡è¦–ã—ã¦ç”»é¢ã«å›ºå®š */
            top: 50%; left: 50%;
            /* ç”»é¢ã®é•·è¾ºã®2å€ã¨ã„ã†è¶…å·¨å¤§ã‚µã‚¤ã‚ºã§è¦†ã„å°½ãã™ */
            width: 200vmax; height: 200vmax;
            /* ç¦ã€…ã—ã„æš—é»’ã¨ç´«ã®è§¦æ‰‹ã®ã‚ˆã†ãªã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ */
            background: radial-gradient(circle at center, transparent 20%, var(--theme-dim) 40%, #000 70%, var(--theme-color) 90%);
            /* ä¸å®šå½¢ã«ã†ã­ã‚‹ãƒã‚¹ã‚¯ */
            border-radius: 40% 60% 70% 30% / 40% 50% 60% 50%;
            /* é€™ã„ã‚ˆã‚‹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
            animation: creep-grow 60s linear infinite alternate;
            /* â˜…é‡è¦â˜… ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ‘ãƒãƒ«ã‚ˆã‚Šæ‰‹å‰ã«è¡¨ç¤ºã™ã‚‹ãŒã€ã‚¯ãƒªãƒƒã‚¯ã¯é€éã•ã›ã‚‹ */
            z-index: 90; 
            pointer-events: none;
            opacity: 0.85;
            filter: blur(30px) contrast(150%); /* è¼ªéƒ­ã‚’å¤§ããã¼ã‹ã—ã¦ææ€–æ„Ÿã‚’ç…½ã‚‹ */
        }
        
        /* L2ã€œL5ã¯ã€å·¨å¤§ãªèƒŒæ™¯(L1)ã®ä¸Šã«ã€ãƒªã‚¢ã‚¯ã‚¿ãƒ¼ã®ä½ç½®ã§è¼ãã‚ˆã†ã« z-index ã‚’èª¿æ•´ */

        /* L2: ç‹‚æ°—ã®æ¸¦ (ç©ºé–“ã®æ­ªã¿) */
        .shape-c10 .L2 { 
            width: 120%; height: 120%; 
            background: repeating-conic-gradient(from 0deg, transparent 0deg 10deg, var(--theme-dim) 10deg 20deg, transparent 20deg 40deg);
            border-radius: 50%;
            mask: radial-gradient(transparent 50%, black 55%);
            -webkit-mask: radial-gradient(transparent 50%, black 55%);
            animation: spin-ccw 20s linear infinite; 
            opacity: 0.6;
            z-index: 91; /* L1ã‚ˆã‚Šä¸Š */
            pointer-events: none;
            animation: slime-writhe 4s ease-in-out infinite;
            filter: brightness(200%);
        }

        /* L3: è™šç©ºã®è£‚ã‘ç›® */
        .shape-c10 .L3 { 
            width: 90%; height: 90%; 
            border: 3px dashed rgba(255, 255, 255, 0.5);
            border-radius: 60% 40% 30% 70% / 60% 30% 70% 40%;
            animation: morph-spin 8s ease-in-out infinite reverse;
            box-shadow: 0 0 30px var(--theme-color), inset 0 0 30px var(--theme-color);
            z-index: 92;
            pointer-events: none;
            animation: core-morphs 5s ease-in-out infinite;
            filter: brightness(200%);
        }

        /* L4: äº‹è±¡ã®åœ°å¹³ç·š (å¸ã„è¾¼ã¾ã‚Œã‚‹æš—é»’) */
        .shape-c10 .L4 { 
            width: 60%; height: 60%; 
            background: #000; 
            border-radius: 50%; 
            box-shadow: 0 0 80px var(--theme-color), inset 0 0 50px #fff; 
            animation: pulse 3s ease-in-out infinite; 
            z-index: 93;
            pointer-events: none;
        }

        /* L5: ã€æ ¸ã€‘ æ²¸é¨°ã™ã‚‹ã€Œè™šç„¡ã®ç‰åº§ã€ (ã‚¢ã‚¶ãƒˆãƒ¼ã‚¹) */
        .shape-c10 .L5 {
            width: 25%; height: 40%;
            position: absolute;
            background: radial-gradient(circle at 30% 30%, #fff, var(--theme-color));
            box-shadow: 0 0 60px var(--theme-color);
            z-index: 6;
            /* ç³ã‚‚æ­ªã¾ã›ã‚‹ */
            animation: core-morph 2.5s ease-in-out infinite;
            filter: brightness(200%);
        }

        /* æ­ªã¿ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ã‚­ãƒ¼ãƒ•ãƒ¬ãƒ¼ãƒ ï¼ˆCSSã®æœ€å¾Œã®æ–¹ã«è¿½åŠ ã—ã¦ã‚‚OKï¼‰ */
        @keyframes morph-spin {
            0% { border-radius: 40% 60% 70% 30% / 40% 50% 60% 50%; transform: translate(-50%, -50%) rotate(0deg); }
            100% { border-radius: 60% 40% 30% 70% / 60% 30% 70% 40%; transform: translate(-50%, -50%) rotate(360deg); }
        }

        h2 { font-size: 1rem; color: var(--theme-color); border-bottom: 1px solid var(--theme-dim); padding-bottom: 5px; margin: 0 0 10px 0; text-shadow: 0 0 8px var(--theme-color); transition: 1s; }
        
        .btn-upgrade, .artifact-card, .challenge-card, .unique-card {
            width: 100%; background: linear-gradient(90deg, rgba(255,255,255, 0.05), transparent);
            border: 1px solid var(--theme-dim); color: var(--text); padding: 10px; margin-bottom: 6px; 
            display: flex; flex-direction: column; gap: 4px; transition: all 0.2s; position: relative; font-family: 'Roboto Mono', monospace;
        }
        .clickable:hover:not(:disabled) { background: rgba(255,255,255, 0.15); border-color: var(--theme-color); box-shadow: 0 0 10px var(--theme-dim); }
        .clickable:active:not(:disabled) { transform: translateY(1px); }
        .clickable:disabled { opacity: 0.4; cursor: not-allowed; border-color: #333; filter: grayscale(1); }

        .artifact-card.normal { border-left: 3px solid var(--rare); }
        .unique-card { border-left: 3px solid var(--unique); }
        .artifact-card.ether { border-left: 3px solid var(--ether); box-shadow: 0 0 5px rgba(255,255,255,0.1); background: linear-gradient(90deg, rgba(255,255,255, 0.1), transparent); }
        
        .unique-card.purchased, .artifact-card.purchased { border-color: #333; opacity: 0.5; cursor: default; }
        .unique-card.purchased::after, .artifact-card.purchased::after {
            content: "ACQUIRED"; position: absolute; top: 50%; left: 50%; 
            transform: translate(-50%, -50%) rotate(-10deg);
            border: 2px solid var(--unique); color: var(--unique); 
            padding: 5px 10px; font-weight: bold; font-family: 'Orbitron'; opacity: 0.8;
            box-shadow: 0 0 10px var(--unique), inset 0 0 10px var(--unique);
        }

        .challenge-header { font-family: 'Orbitron'; font-size: 0.8rem; color: var(--theme-color); margin-top: 15px; margin-bottom: 5px; border-bottom: 1px dashed #444; padding-bottom: 2px; text-shadow: 0 0 5px var(--theme-color); }
        .challenge-card { border-left: 3px solid #555; cursor: default; background: rgba(0,0,0,0.3); }
        .challenge-card.claimable { border-left-color: var(--boost); background: rgba(255, 136, 0, 0.15); box-shadow: inset 0 0 15px rgba(255,136,0,0.1); }
        .challenge-card.completed { border-left-color: var(--unique); background: rgba(0, 255, 0, 0.05); }

        .claim-btn, .special-btn { background: var(--boost); color: #000; border: none; padding: 6px 10px; font-weight: bold; cursor: pointer; font-family: 'Orbitron'; font-size: 0.8rem; width: 100%; margin-top: 5px; border-radius: 2px; box-shadow: 0 0 10px var(--boost); transition: all 0.2s; }
        .claim-btn:hover, .special-btn:hover { background: #ffaa33; box-shadow: 0 0 20px var(--boost); filter: brightness(1.2); }
        .special-btn { background: var(--unique); box-shadow: 0 0 10px var(--unique); }
        .special-btn:hover { background: #55ff55; box-shadow: 0 0 20px var(--unique); }

        #btn-buy-all-max { margin-bottom: 15px; }

        .auto-buy-wrapper { position: absolute; right: 10px; top: 35px; z-index: 5; display: flex; align-items: center; gap: 5px; }
        .toggle-label { font-size: 0.7rem; color: #aaa; }
        .toggle-switch { position: relative; width: 30px; height: 16px; background: #333; border-radius: 8px; cursor: pointer; transition: 0.3s; box-shadow: inset 0 0 5px #000; }
        .toggle-switch::after { content: ''; position: absolute; top: 2px; left: 2px; width: 12px; height: 12px; background: #fff; border-radius: 50%; transition: 0.3s; box-shadow: 0 0 5px #fff; }
        .toggle-switch.active { background: var(--unique); box-shadow: 0 0 10px var(--unique); }
        .toggle-switch.active::after { transform: translateX(14px); }

        .buy-controls { display: flex; gap: 5px; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid var(--theme-dim); }
        .buy-btn { flex: 1; background: rgba(0,0,0,0.3); border: 1px solid var(--theme-dim); color: var(--text); padding: 4px; cursor: pointer; font-family: 'Orbitron'; font-size: 0.8rem; text-align: center; transition: 0.2s; display: none; opacity: 0.3; }
        .buy-btn.unlocked { display: block; opacity: 0.6; }
        .buy-btn.unlocked:hover { opacity: 1; text-shadow: 0 0 5px currentColor;}
        .buy-btn.active { background: var(--theme-dim); color: #fff; border-color: var(--theme-color); opacity: 1; box-shadow: 0 0 10px var(--theme-dim); }

        .btn-row { display: flex; justify-content: space-between; align-items: center; width: 100%; }
        .item-name { font-weight: bold; color: #fff; font-size: 0.9rem; text-shadow: 0 0 3px currentColor; }
        .cost-text { color: var(--gold); font-weight: bold; font-family: 'Orbitron'; font-size: 0.85rem; text-shadow: 0 0 3px var(--gold); }
        .relic-text { color: var(--rare); font-weight: bold; text-shadow: 0 0 5px var(--rare); }
        .ether-text { color: var(--ether); font-weight: bold; text-shadow: 0 0 8px #fff; }
        .effect-row { font-size: 0.75rem; color: #aaa; margin-top: 2px; display: flex; align-items: center; gap: 5px; }
        .val-curr { color: var(--text); }
        .val-next { color: var(--theme-color); font-weight: bold; text-shadow: 0 0 3px var(--theme-color); }

        .tab-menu { display: flex; margin-bottom: 10px; gap: 5px; }
        .tab-btn { flex: 1; background: transparent; border: 1px solid var(--theme-dim); color: var(--text); padding: 5px; cursor: pointer; font-family: 'Orbitron'; font-size: 0.7rem; transition: 0.3s; opacity: 0.6; }
        .tab-btn:hover { opacity: 1; border-color: var(--theme-color); box-shadow: 0 0 5px var(--theme-dim); }
        .tab-btn.active { background: var(--theme-dim); color: #fff; opacity: 1; box-shadow: 0 0 10px var(--theme-dim); border-color: var(--theme-color); }

        #btn-prestige { background: linear-gradient(135deg, #220011, #440022); border: 1px solid var(--accent); margin-top: 10px; padding: 15px; text-align: center; width: 100%; color: #fff; cursor: pointer; box-shadow: 0 0 15px var(--accent); transition: all 0.3s; }
        #btn-prestige:hover:not(:disabled) { 
            background: linear-gradient(135deg, #440022, #660033); 
            box-shadow: 0 0 30px var(--accent); 
            filter: brightness(1.2);
        }
        #btn-prestige:disabled { opacity: 0.5; cursor: not-allowed; box-shadow: none; filter: grayscale(1); }

        #btn-transcend { background: linear-gradient(135deg, #111, #333); border: 1px solid #fff; color: #fff; margin-top: 20px; padding: 15px; text-align: center; width: 100%; cursor: pointer; box-shadow: 0 0 15px #fff; display: none; transition: all 0.3s; }
        #btn-transcend:hover:not(:disabled) { 
            background: #222; box-shadow: 0 0 30px #fff; 
            filter: brightness(1.2); 
        }
        #btn-transcend:disabled { opacity: 0.5; cursor: not-allowed; box-shadow: none; }

        #btn-apotheosis { 
            background: linear-gradient(135deg, #002233, #004455); 
            border: 2px solid var(--god); 
            color: var(--god); 
            margin-top: 20px; 
            padding: 15px; 
            text-align: center; 
            width: 100%; 
            cursor: pointer; 
            box-shadow: 0 0 20px var(--god), inset 0 0 20px rgba(0,255,255,0.2); 
            display: none; 
            transition: all 0.5s; 
            position: relative;
            overflow: hidden;
        }
        #btn-apotheosis::before {
            content: ''; position: absolute; top:-50%; left:-50%; width:200%; height:200%;
            background: radial-gradient(circle, rgba(255,255,255,0.2), transparent 70%);
            transform: scale(0); transition: transform 0.5s;
        }
        #btn-apotheosis:hover:not(:disabled)::before { transform: scale(1); }
        #btn-apotheosis:hover:not(:disabled) { 
            background: #005566; box-shadow: 0 0 40px var(--god); 
            filter: brightness(1.2); color: #fff; text-shadow: 0 0 10px var(--god);
        }
        #btn-apotheosis:disabled { opacity: 0.5; cursor: not-allowed; box-shadow: none; filter: grayscale(1); border-color: #555; color: #aaa; }


        .floater { position: absolute; color: #fff; font-weight: bold; pointer-events: none; animation: floatUp 0.8s ease-out forwards; font-family: 'Orbitron'; text-shadow: 0 0 10px var(--theme-color), 0 0 20px var(--theme-color); font-size: 1.1rem; }
        @keyframes floatUp { 0% { opacity: 1; transform: translateY(0) scale(1); } 100% { opacity: 0; transform: translateY(-60px) scale(1.2); } }

        #settings-icon { position: fixed; bottom: 20px; right: 20px; width: 45px; height: 45px; background: rgba(0,0,0,0.9); border: 2px solid var(--theme-color); border-radius: 50%; color: var(--theme-color); display: flex; align-items: center; justify-content: center; font-size: 1.5rem; cursor: pointer; z-index: 200; box-shadow: 0 0 15px var(--theme-color); transition: 0.3s; }
        #settings-icon:hover { transform: rotate(90deg); box-shadow: 0 0 25px var(--theme-color); }

        #modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 300; display: none; align-items: center; justify-content: center; backdrop-filter: blur(8px); }
        
        .modal-content { 
            background: rgba(10, 15, 25, 0.95); 
            border: 1px solid var(--theme-color); 
            box-shadow: 0 0 50px var(--theme-dim); 
            width: 800px; 
            max-width: 95vw;
            max-height: 90vh;
            overflow-y: auto;
            padding: 25px; 
            position: relative; 
            display: flex;
            flex-direction: column;
        }
        
        .settings-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-top: 10px;
        }
        
        @media (max-width: 768px) {
            .settings-container {
                grid-template-columns: 1fr;
            }
        }

        .modal-close { position: absolute; top: 15px; right: 20px; font-size: 1.8rem; cursor: pointer; color: var(--theme-color); z-index: 10;}

        .setting-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px dashed #333; }
        .setting-label { color: #fff; font-size: 0.9rem; }
        .setting-control select, .setting-control input { background: #111; color: #fff; border: 1px solid var(--theme-dim); padding: 4px; font-family: 'Roboto Mono'; }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #050505; }
        ::-webkit-scrollbar-thumb { background: var(--theme-dim); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--theme-color); }
    </style>
</head>
<body>
    <div id="bg-grid"></div>
    <div id="bg-glow"></div>
    <canvas id="particleCanvas"></canvas>

    <div id="skin-btn" style="position: fixed; bottom: 20px; right: 75px; width: 45px; height: 45px; background: rgba(0,0,0,0.9); border: 2px solid var(--theme-color); border-radius: 50%; color: var(--theme-color); display: none; align-items: center; justify-content: center; font-size: 1.5rem; cursor: pointer; z-index: 200; box-shadow: 0 0 15px var(--theme-color); transition: 0.3s;" onclick="toggleSkinModal(document.getElementById('skin-modal').style.display !== 'flex')">ğŸ¨</div>
    <div id="settings-icon" onclick="toggleModal(true)">âš™</div>
    <div id="modal-overlay" onclick="if(event.target === this) toggleModal(false)">
        <div class="modal-content">
            <div class="modal-close" onclick="toggleModal(false)">Ã—</div>
            
            <div class="settings-container">
                <div class="settings-col">
                    <h3 id="ui-graphics-title" style="color:var(--theme-color); border-bottom:1px solid #333; padding-bottom:5px; margin-top:0;">GRAPHICS SETTINGS</h3>
                    
                    <div class="setting-row">
                        <span class="setting-label" id="ui-label-particles">ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«é‡</span>
                        <div class="setting-control">
                            <select id="set-particles" onchange="updateGraphics('particles', this.value)">
                                <option value="high">High</option>
                                <option value="med">Medium</option>
                                <option value="low">Low</option>
                            </select>
                        </div>
                    </div>
                    <div class="setting-row">
                        <span class="setting-label" id="ui-label-bloom">BloomåŠ¹æœ</span>
                        <div class="setting-control">
                            <label style="color:#aaa;"><input type="checkbox" id="set-bloom" onchange="updateGraphics('bloom', this.checked)"> Enable</label>
                        </div>
                    </div>
                    <div class="setting-row">
                        <span class="setting-label" id="ui-label-blur">BluråŠ¹æœ</span>
                        <div class="setting-control">
                            <label style="color:#aaa;"><input type="checkbox" id="set-blur" onchange="updateGraphics('blur', this.checked)"> Enable</label>
                        </div>
                    </div>
                    <div class="setting-row">
                        <span class="setting-label" id="ui-label-bgcolor">èƒŒæ™¯ã‚«ãƒ©ãƒ¼</span>
                        <div class="setting-control">
                            <label style="color:#aaa;"><input type="checkbox" id="set-bg-color" onchange="updateGraphics('bgColor', this.checked)"> Enable</label>
                        </div>
                    </div>
                    <div class="setting-row">
                        <span class="setting-label" id="ui-label-numbers">ãƒ€ãƒ¡ãƒ¼ã‚¸æ•°å€¤</span>
                        <div class="setting-control">
                            <label style="color:#aaa;"><input type="checkbox" id="set-numbers" onchange="updateGraphics('numbers', this.checked)"> Enable</label>
                        </div>
                    </div>
                    <div class="setting-row">
                        <span class="setting-label" id="ui-label-confirm">ãƒªã‚»ãƒƒãƒˆç¢ºèª</span>
                        <div class="setting-control">
                            <label style="color:#aaa;"><input type="checkbox" id="set-confirm" onchange="updateGraphics('confirmations', this.checked)"> Enable</label>
                        </div>
                    </div>
                    <div class="setting-row">
                        <span class="setting-label" id="ui-label-lang">è¨€èªè¨­å®š / LANGUAGE</span>
                        <div class="setting-control">
                            <select id="set-lang" onchange="updateGraphics('lang', this.value)">
                                <option value="ja">æ—¥æœ¬èª</option>
                                <option value="en">English</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="settings-col">
                    <h3 id="ui-data-title" style="color:var(--theme-color); border-bottom:1px solid #333; padding-bottom:5px; margin-top:0;">DATA MANAGEMENT</h3>
                    <div style="display:flex; gap:10px; margin-bottom:20px;">
                        <button class="btn-upgrade clickable" onclick="exportSave()" style="border-color:var(--theme-color); color:var(--theme-color); text-align:center;">
                            ğŸ“¤ EXPORT
                        </button>
                        <button class="btn-upgrade clickable" onclick="importSave()" style="border-color:var(--gold); color:var(--gold); text-align:center;">
                            ğŸ“¥ IMPORT
                        </button>
                    </div>

                    <h3 id="ui-system-title" style="color:var(--theme-color); border-bottom:1px solid #333; padding-bottom:5px;">SYSTEM</h3>
                    <p id="ui-save-desc" style="font-size:0.9rem; margin-bottom:10px;">ã‚²ãƒ¼ãƒ ã®é€²è¡ŒçŠ¶æ³ã‚’ä¿å­˜ã—ã¾ã™ã€‚</p>
                    <button id="btn-manual-save" class="btn-upgrade clickable" onclick="manualSave()" style="border-color:var(--unique); color:var(--unique); text-align:center; margin-bottom:20px; box-shadow: 0 0 10px var(--unique);">
                        ğŸ’¾ SAVE GAME
                    </button>
                    <p id="ui-reset-desc" style="font-size:0.9rem; margin-top:20px; border-top:1px solid #333; padding-top:15px; margin-bottom:10px;">ã‚²ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ</p>
                    <button id="ui-btn-delete" class="btn-upgrade clickable" onclick="resetSave()" style="border-color:#f55; color:#f55; text-align:center; box-shadow: 0 0 10px #f55;">
                        âš  DELETE SAVE DATA
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="skin-modal" class="modal-overlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: transparent; z-index: 300; display: none; align-items: center; justify-content: flex-end; pointer-events: none;" onclick="if(event.target === this) toggleSkinModal(false)">
        <div class="modal-content" style="width: 320px; margin-right: 30px; pointer-events: auto; box-shadow: 0 0 30px rgba(0,0,0,1); background-color: #0a0f19 !important; backdrop-filter: none !important; opacity: 1 !important;">
            <h2 class="tech-font" id="skin-menu-title">SKIN MENU</h2>
            
            <div id="manual-skin-controls" style="margin-top:10px;">
                <div class="setting-row">
                    <span class="setting-label" id="skin-label-color">COLOR</span>
                    <div class="setting-control">
                        <select id="skin-color-select" onchange="updateManualSkin()" style="background:#111; color:#fff; border:1px solid var(--theme-dim); padding:4px; font-family:'Roboto Mono';"></select>
                    </div>
                </div>
                <div class="setting-row">
                    <span class="setting-label" id="skin-label-shape">SHAPE</span>
                    <div class="setting-control">
                        <select id="skin-shape-select" onchange="updateManualSkin()" style="background:#111; color:#fff; border:1px solid var(--theme-dim); padding:4px; font-family:'Roboto Mono';"></select>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="game-layout">
        <div class="sidebar">
            <h2 id="ui-module-header">>> MODULES</h2>
            <button id="btn-buy-all-max" class="special-btn" style="display:none;" onclick="buyAllModulesMax()">
                >> BUY ALL MAX
            </button>

            <div class="buy-controls">
                <div id="btn-buy-1" class="buy-btn unlocked active" onclick="setBuyMode(1)">x1</div>
                <div id="btn-buy-5" class="buy-btn" onclick="setBuyMode(5)">x5</div>
                <div id="btn-buy-10" class="buy-btn" onclick="setBuyMode(10)">x10</div>
                <div id="btn-buy-max" class="buy-btn" onclick="setBuyMode(-1)">MAX</div>
            </div>
            <div id="upgrade-list" class="scroll-area"></div>
        </div>

        <div id="center-stage">
            <div id="header-stats">
                <div id="score-display">0</div>
                <div id="header-relic-display" style="display:none;">ğŸ’ 0</div>
                <div id="mps-display">0 / sec</div>
            </div>

            <div id="reactor-wrapper" class="shape-c0">
                <div class="r-layer L1"></div>
                <div class="r-layer L2"></div>
                <div class="r-layer L3"></div>
                <div class="r-layer L4 core-glow"></div>
                <div class="r-layer L5"></div>
            </div>

            <div class="phase-container">
                <span id="stage-badge">Phase 1</span>
                <div id="stage-progress-bg"><div id="stage-progress-fill"></div></div>
                <div id="stage-req-text">Next: 3.00M</div>
            </div>
        </div>

        <div class="sidebar">
            <div class="tab-menu">
                <button id="ui-tab-system" class="tab-btn active" onclick="switchTab('system', this)">SYSTEM</button>
                <button id="tab-btn-artifacts" class="tab-btn" onclick="switchTab('artifacts', this)" style="display:none;">ARTIFACTS</button>
                <button id="ui-tab-challenges" class="tab-btn" onclick="switchTab('challenges', this)">CHALLENGES</button>
                <button id="tab-btn-transcend" class="tab-btn" onclick="switchTab('transcend', this)" style="color:var(--ether); display:none;">TRANSCEND</button>
            </div>

            <div id="tab-system" class="scroll-area tab-content">
                <div style="padding:10px; background:rgba(0,0,0,0.3); border:1px solid var(--theme-dim); font-size:0.9rem; box-shadow: inset 0 0 20px rgba(0,0,0,0.5);">
                    <div><span id="ui-label-mult">å€ç‡</span>: <span id="current-mult" style="color:var(--theme-color)">x1.00</span></div>
                    <div><span id="ui-label-bonus">ç”Ÿç”£ãƒœãƒ¼ãƒŠã‚¹</span>: <span id="sys-chal-bonus" style="color:var(--gold)">+0%</span></div>
                    
                    <div id="stat-row-relic" style="display:none;"><span id="ui-label-relic">ãƒ¬ãƒªãƒƒã‚¯</span>: <span id="relic-count" class="relic-text">0</span></div>
                    <div id="stat-row-ether" style="display:none;"><span id="ui-label-ether">ã‚¨ãƒ¼ãƒ†ãƒ«</span>: <span id="ether-count" class="ether-text">0</span></div>
                    
                    <div style="margin-top:5px; border-top:1px dashed #444; padding-top:5px;"></div>
                    <div><span id="ui-label-clicks">ç´¯è¨ˆã‚¯ãƒªãƒƒã‚¯</span>: <span id="stat-clicks">0</span></div>
                    
                    <div id="stat-row-prestige" style="display:none;"><span id="ui-label-prestige-count">è»¢ç”Ÿå›æ•°</span>: <span id="sys-prestige">0</span></div>
                    <div id="stat-row-transcend" style="display:none;"><span id="ui-label-transcend-count">è¶…è¶Šå›æ•°</span>: <span id="sys-transcend">0</span></div>
                    <div id="stat-row-apotheosis" style="display:none;"><span id="ui-label-apotheosis-count">çœŸåŒ–å›æ•°</span>: <span id="sys-apotheosis" style="color:var(--god); font-weight:bold;">0</span></div>
                    
                    <div><span id="ui-label-online">ã‚ªãƒ³ãƒ©ã‚¤ãƒ³æ™‚é–“</span>: <span id="sys-time">00:00:00</span></div>
                </div>
                <button id="btn-prestige" onclick="tryPrestige()">
                    <div class="tech-font" style="font-size:1.1rem; margin-bottom:5px;">DIMENSION RESET</div>
                    <div id="ui-prestige-desc" style="font-size:0.8rem; color:#ffaab9;">é€²è¡Œãƒªã‚»ãƒƒãƒˆ / ãƒ¬ãƒªãƒƒã‚¯ç²å¾—</div>
                    <div id="prestige-gain" style="font-size:1rem; font-weight:bold; margin-top:5px; text-shadow:0 0 5px #ff55aa;">+0 Relics</div>
                </button>

                <button id="btn-transcend" onclick="tryTranscend()">
                    <div class="tech-font" style="font-size:1.2rem;">TRANSCENDENCE</div>
                    <div id="ui-transcend-desc" style="font-size:0.75rem; color:#aaa; margin-top:5px;">
                        å…¨ã¦ã‚’ãƒªã‚»ãƒƒãƒˆã—ã€ä¸Šä½æ¬¡å…ƒã¸åˆ°é”ã™ã‚‹ã€‚<br>
                        ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã€ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã€é€²è¡Œåº¦ã¯å¤±ã‚ã‚Œã¾ã™ã€‚
                    </div>
                    <div id="transcend-req" style="margin-top:10px; font-weight:bold; color:#f55; text-shadow:0 0 5px #f00;">REQ: 50,000 Relics</div>
                    <div id="transcend-gain" style="color:var(--ether); font-weight:bold; text-shadow:0 0 10px #fff;">GAIN: +1 Ether</div>
                </button>

                <button id="btn-apotheosis" onclick="tryApotheosis()">
                    <div class="tech-font" style="font-size:1.3rem;">APOTHEOSIS</div>
                    <div id="ui-apotheosis-desc" style="font-size:0.75rem; color:#acf; margin-top:5px;">
                        æ¬¡å…ƒã®æ çµ„ã¿ã‚’è¶…è¶Šã—ã€ç¥æ€§é ˜åŸŸã¸ã€‚<br>
                        ã‚¨ãƒ¼ãƒ†ãƒ«ã€è¶…è¶Šã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã‚’å«ã‚€å…¨ã¦ã‚’ãƒªã‚»ãƒƒãƒˆã€‚
                    </div>
                    <div id="apotheosis-req" style="margin-top:10px; font-weight:bold; color:#f55; text-shadow:0 0 5px #f00;">REQ: Phase 20</div>
                    <div id="apotheosis-gain" style="color:var(--god); font-weight:bold; text-shadow:0 0 10px var(--god);">NEXT: Relic/Ether x2</div>
                </button>
            </div>

            <div id="tab-artifacts" class="scroll-area tab-content" style="display:none;">
                <div style="margin-bottom:10px; color:var(--rare); font-size:0.9rem; text-align:right;">
                    Relics: <span id="artifact-relic-display">0</span>
                </div>
                <h3 id="ui-unique-header" style="color:var(--unique); font-size:0.9rem; border-bottom:1px dashed var(--unique); margin:15px 0 5px 0;">>> SYSTEM UPGRADES (Unique)</h3>
                <div id="unique-list"></div>
                <h3 id="ui-standard-header" style="color:var(--rare); font-size:0.9rem; border-bottom:1px dashed var(--rare); margin:15px 0 5px 0;">>> STANDARD ARTIFACTS</h3>
                <div id="artifact-list"></div>
            </div>

            <div id="tab-challenges" class="scroll-area tab-content" style="display:none;">
                <div style="margin-bottom:10px; padding:10px; background:rgba(0,0,0,0.3); border:1px solid var(--theme-dim); font-size:0.85rem; box-shadow: inset 0 0 20px rgba(0,0,0,0.5);">
                    <div><span id="ui-label-global-bonus">ã‚°ãƒ­ãƒ¼ãƒãƒ«ç”Ÿç”£ãƒœãƒ¼ãƒŠã‚¹</span>: <span id="chal-total-bonus" style="color:var(--gold); font-weight:bold; text-shadow: 0 0 5px var(--gold);">+0%</span></div>
                    <div id="ui-chal-note" style="font-size:0.75rem; color:#aaa; margin-top:4px;">(â€»ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«å€‹åˆ¥å¼·åŒ–ã¯å«ã¾ã‚Œã¾ã›ã‚“)</div>
                </div>
                <button id="btn-claim-all" class="special-btn" style="display:none; margin-bottom:15px;" onclick="claimAllChallenges()">
                    CLAIM ALL REWARDS
                </button>
                <div id="challenge-list"></div>
            </div>

            <div id="tab-transcend" class="scroll-area tab-content" style="display:none;">
                <div style="text-align:center; margin-bottom:15px; padding:10px; background:rgba(255,255,255,0.05); border:1px solid #fff; box-shadow: 0 0 15px rgba(255,255,255,0.2);">
                    <div style="font-size:0.8rem;">ETHEREAL ENERGY</div>
                    <div id="ether-display" class="ether-text" style="font-size:1.5rem;">0</div>
                </div>
                <h3 id="ui-advanced-header" style="color:var(--ether); font-size:0.9rem; border-bottom:1px dashed #fff; margin-bottom:10px;">>> ADVANCED ARTIFACTS</h3>
                <div id="advanced-list"></div>
            </div>
        </div>
    </div>

<script>
/* =========================================
    LANG DATA
   ========================================= */
const LANG_DATA = {
    ja: {
        graphicsTitle: "GRAPHICS SETTINGS",
        labelParticles: "ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«é‡",
        labelBloom: "BloomåŠ¹æœ",
        labelBlur: "BluråŠ¹æœ",
        labelBgColor: "èƒŒæ™¯ã‚«ãƒ©ãƒ¼",
        labelNumbers: "ãƒ€ãƒ¡ãƒ¼ã‚¸æ•°å€¤",
        labelConfirm: "ãƒªã‚»ãƒƒãƒˆç¢ºèª",
        labelLang: "è¨€èªè¨­å®š / LANGUAGE",
        dataTitle: "DATA MANAGEMENT",
        systemTitle: "SYSTEM",
        saveDesc: "ã‚²ãƒ¼ãƒ ã®é€²è¡ŒçŠ¶æ³ã‚’ä¿å­˜ã—ã¾ã™ã€‚",
        resetDesc: "ã‚²ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ",
        btnDelete: "âš  DELETE SAVE DATA",
        moduleHeader: ">> MODULES",
        tabSystem: "SYSTEM",
        tabChallenges: "CHALLENGES",
        labelMult: "å€ç‡",
        labelBonus: "ç”Ÿç”£ãƒœãƒ¼ãƒŠã‚¹",
        labelRelic: "ãƒ¬ãƒªãƒƒã‚¯",
        labelEther: "ã‚¨ãƒ¼ãƒ†ãƒ«",
        labelClicks: "ç´¯è¨ˆã‚¯ãƒªãƒƒã‚¯",
        labelPrestigeCount: "è»¢ç”Ÿå›æ•°",
        labelTranscendCount: "è¶…è¶Šå›æ•°",
        labelApotheosisCount: "çœŸåŒ–å›æ•°",
        labelOnline: "ã‚ªãƒ³ãƒ©ã‚¤ãƒ³æ™‚é–“",
        prestigeDesc: "é€²è¡Œãƒªã‚»ãƒƒãƒˆ / ãƒ¬ãƒªãƒƒã‚¯ç²å¾—",
        transcendDesc: "å…¨ã¦ã‚’ãƒªã‚»ãƒƒãƒˆã—ã€ä¸Šä½æ¬¡å…ƒã¸åˆ°é”ã™ã‚‹ã€‚<br>ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã€ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã€é€²è¡Œåº¦ã¯å¤±ã‚ã‚Œã¾ã™ã€‚",
        apotheosisDesc: "æ¬¡å…ƒã®æ çµ„ã¿ã‚’è¶…è¶Šã—ã€ç¥æ€§é ˜åŸŸã¸ã€‚<br>å…¨ã¦ã‚’ãƒªã‚»ãƒƒãƒˆã™ã‚‹ãŒã€å¼·åŠ›ãªåˆæœŸãƒªã‚½ãƒ¼ã‚¹ãƒœãƒ¼ãƒŠã‚¹ã‚’å¾—ã‚‹ã€‚",
        uniqueHeader: ">> SYSTEM UPGRADES (Unique)",
        standardHeader: ">> STANDARD ARTIFACTS",
        advancedHeader: ">> ADVANCED ARTIFACTS",
        labelGlobalBonus: "ã‚°ãƒ­ãƒ¼ãƒãƒ«ç”Ÿç”£ãƒœãƒ¼ãƒŠã‚¹",
        chalNote: "(â€»ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«å€‹åˆ¥å¼·åŒ–ã¯å«ã¾ã‚Œã¾ã›ã‚“)",
        catStat: "çµ±è¨ˆ (Statistics)",
        catModule: "ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ« (Modules)",
        catUnique: "ã‚·ã‚¹ãƒ†ãƒ æ‹¡å¼µ (Unique)",
        catArtifact: "ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆ (Artifacts)",
        catAdvanced: "è¶…è¶Š (Transcendence)",
        passiveProduce: "[PASSIVE] ç”Ÿç”£é‡UP",
        passiveModule: "[PASSIVE] ç”Ÿç”£ x2",
        passiveGlobal: "[PASSIVE] å…¨ç”Ÿç”£",
        btnClaim: "CLAIM REWARD",
        skinMenuTitle: "SKIN MENU",
        labelSkinColor: "ã‚«ãƒ©ãƒ¼",
        labelSkinShape: "å½¢çŠ¶",
        labelSkinAuto: "ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ"
    },
    en: {
        graphicsTitle: "GRAPHICS SETTINGS",
        labelParticles: "Particle Amount",
        labelBloom: "Bloom Effect",
        labelBlur: "Blur Effect",
        labelBgColor: "Background Color",
        labelNumbers: "Damage Numbers",
        labelConfirm: "Confirm Reset",
        labelLang: "è¨€èªè¨­å®š / LANGUAGE",
        dataTitle: "DATA MANAGEMENT",
        systemTitle: "SYSTEM",
        saveDesc: "Saves the game progress.",
        resetDesc: "Reset game data?",
        btnDelete: "âš  DELETE SAVE DATA",
        moduleHeader: ">> MODULES",
        tabSystem: "SYSTEM",
        tabChallenges: "CHALLENGES",
        labelMult: "Multiplier",
        labelBonus: "Production Bonus",
        labelRelic: "Relics",
        labelEther: "Ether",
        labelClicks: "Total Clicks",
        labelPrestigeCount: "Total Prestige",
        labelTranscendCount: "Total Transcend",
        labelApotheosisCount: "Apotheosis",
        labelOnline: "Online Time",
        prestigeDesc: "Reset progress / Gain Relics",
        transcendDesc: "Reset everything to reach a higher dimension.<br>Artifacts, modules, and progress will be lost.",
        apotheosisDesc: "[Apotheosis] Transcend dimension.<br>Resets everything, but grants permanent starting resource bonus.",
        uniqueHeader: ">> SYSTEM UPGRADES (Unique)",
        standardHeader: ">> STANDARD ARTIFACTS",
        advancedHeader: ">> ADVANCED ARTIFACTS",
        labelGlobalBonus: "Global Production Bonus",
        chalNote: "(*Individual module boosts not included)",
        catStat: "Statistics",
        catModule: "Modules",
        catUnique: "Unique Systems",
        catArtifact: "Artifacts",
        catAdvanced: "Transcendence",
        passiveProduce: "[PASSIVE] Production UP",
        passiveModule: "[PASSIVE] Production x2",
        passiveGlobal: "[PASSIVE] Global Prod.",
        btnClaim: "CLAIM REWARD",
        skinMenuTitle: "SKIN MENU",
        labelSkinColor: "COLOR",
        labelSkinShape: "SHAPE",
        labelSkinAuto: "Default"
    }
};

/* =========================================
    GAME DATA & CONFIG
   ========================================= */
const PRESTIGE_THRESHOLD = 1000000;

const STAGE_DEFS = [
    { name: "Cyan",         name_ja: "æ°´è‰²",         color: "#00f7ff", dim: "#005f6b" },
    { name: "Spring Green", name_ja: "é»„ç·‘è‰²",       color: "#00ff88", dim: "#006b38" },
    { name: "Purple",       name_ja: "ç´«è‰²",         color: "#aa00ff", dim: "#4b006b" },
    { name: "Red",          name_ja: "èµ¤è‰²",         color: "#ff3333", dim: "#6b0000" }, 
    { name: "Gold",         name_ja: "é‡‘è‰²",         color: "#ffd700", dim: "#6b5a00" },
    { name: "Magenta",      name_ja: "æ¡ƒè‰²",         color: "#ff00ff", dim: "#6b006b" },
    { name: "Orange",       name_ja: "æ©™è‰²",         color: "#ff8800", dim: "#6b3b00" },
    { name: "White",        name_ja: "ç™½è‰²",         color: "#ffffff", dim: "#444444" },
    { name: "Sky Blue",     name_ja: "ç©ºè‰²",         color: "#00ffff", dim: "#006b6b" },
    { name: "Crimson",      name_ja: "ç´…èµ¤è‰²",       color: "#ff0055", dim: "#6b0024" },
    { name: "Deep Purple",  name_ja: "æ·±ç´«è‰²",       color: "#9900ff", dim: "#3a006b" }
];

const CYCLE_SHAPE_CLASSES = [
    "shape-c0", "shape-c1", "shape-c2", "shape-c3", "shape-c4",
    "shape-c5", "shape-c6", "shape-c7", "shape-c8", "shape-c9","shape-c10"
];

const MODULE_DATA = {
    cursor:   { baseCost: 15,     power: 1,       name_ja: "ã‚¯ã‚©ãƒ³ã‚¿ãƒ ãƒ»ã‚«ãƒ¼ã‚½ãƒ«", name_en: "Quantum Cursor", type: "click" },
    drone:    { baseCost: 120,    power: 10,      name_ja: "è‡ªå¾‹å‹æ¡æ˜ãƒ‰ãƒ­ãƒ¼ãƒ³", name_en: "Auto-Mining Drone", type: "auto" },
    network:  { baseCost: 650,    power: 45,      name_ja: "ãƒ‹ãƒ¥ãƒ¼ãƒ©ãƒ«ãƒ»ãƒªãƒ³ã‚¯", name_en: "Neural Link", type: "auto" },
    plant:    { baseCost: 1800,   power: 120,     name_ja: "ãƒ€ãƒ¼ã‚¯ãƒã‚¿ãƒ¼ç™ºé›»æ‰€", name_en: "Dark Matter Plant", type: "auto" },
    server:   { baseCost: 8500,   power: 400,     name_ja: "é‡å­ã‚µãƒ¼ãƒãƒ¼ãƒ»ã‚¯ãƒ©ã‚¹ã‚¿", name_en: "Quantum Server Cluster", type: "auto" },
    reactor:  { baseCost: 25000,  power: 1200,    name_ja: "æ ¸èåˆãƒªã‚¢ã‚¯ã‚¿ãƒ¼", name_en: "Fusion Reactor", type: "auto" },
    collider: { baseCost: 150000, power: 6000,    name_ja: "ãƒãƒ‰ãƒ­ãƒ³ç²’å­åŠ é€Ÿå™¨", name_en: "Hadron Collider", type: "auto" },
    matrix:   { baseCost: 1e6,    power: 35000,   name_ja: "ãƒãƒˆãƒªãƒƒã‚¯ã‚¹æ¥ç¶šè£…ç½®", name_en: "Matrix Interface", type: "auto" },
    star:     { baseCost: 50e6,   power: 150000,  name_ja: "ãƒ€ã‚¤ã‚½ãƒ³ãƒ»ã‚¹ãƒ•ã‚£ã‚¢", name_en: "Dyson Sphere", type: "auto" },
    galaxy:   { baseCost: 5e9,    power: 2e6,     name_ja: "éŠ€æ²³ãƒãƒ¼ãƒ™ã‚¹ã‚¿ãƒ¼", name_en: "Galaxy Harvester", type: "auto" },
    dimension:{ baseCost: 2e11,   power: 1.5e7,   name_ja: "æ¬¡å…ƒç©¿å­”ãƒ‰ãƒªãƒ«", name_en: "Dimension Drill", type: "auto" },
    timeline: { baseCost: 5e13,   power: 8e7,     name_ja: "æ™‚é–“è»¸å®‰å®šåŒ–è£…ç½®", name_en: "Timeline Stabilizer", type: "auto" },
    reality:  { baseCost: 2e16,   power: 5e8,     name_ja: "ç¾å®Ÿæ”¹å¤‰ã‚¨ãƒ³ã‚¸ãƒ³", name_en: "Reality Engine", type: "auto" },
    entropy:  { baseCost: 1e19,   power: 3e9,     name_ja: "ã‚¨ãƒ³ãƒˆãƒ­ãƒ”ãƒ¼ç‚‰å¿ƒ", name_en: "Entropy Core", type: "auto" },
    omega:    { baseCost: 2e22,   power: 2e10,    name_ja: "ã‚ªãƒ¡ã‚¬ãƒ»ãƒã‚¤ãƒ³ãƒˆ", name_en: "Omega Point", type: "auto" },
    akashic:  { baseCost: 3e33,   power: 1e14,    name_ja: "ã‚¢ã‚«ã‚·ãƒƒã‚¯ãƒ»ãƒ¬ã‚³ãƒ¼ãƒ‰", name_en: "Akashic Record", type: "auto" },
    causality:{ baseCost: 4e44,   power: 8e18,    name_ja: "å› æœå¾‹ç´¡ç¸¾æ©Ÿ", name_en: "Causality Weaver", type: "auto" },
    multiverse:{ baseCost: 5e55,  power: 5e22,    name_ja: "å¤šå…ƒå®‡å®™è†œ", name_en: "Multiverse Membrane", type: "auto" },
    genesis:  { baseCost: 6e66,   power: 4e26,    name_ja: "å‰µä¸–ã®ç«èŠ±", name_en: "Genesis Spark", type: "auto" },
    throne:   { baseCost: 7e77,   power: 5e30,    name_ja: "è™šç„¡ã®ç‰åº§", name_en: "Void Throne", type: "auto" }
};

const ARTIFACT_DATA = {
    'art_power':    { name_ja: "é‡å­å¢—å¹…å™¨", name_en: "Quantum Amplifier", desc_ja: "ç”Ÿç”£é‡UP", desc_en: "Prod. Multiplier", baseCost: 1, type: "mult", icon: "âš¡" },
    'art_cost':     { name_ja: "ãƒŠãƒæ ¼å­æ§‹é€ ", name_en: "Nano-Lattice", desc_ja: "ã‚³ã‚¹ãƒˆå‰²å¼•", desc_en: "Cost Discount", baseCost: 3, type: "discount", icon: "ğŸ“‰" },
    'art_crit':     { name_ja: "ã‚«ã‚ªã‚¹å›è·¯", name_en: "Chaos Circuit", desc_ja: "ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ç‡", desc_en: "Crit Chance", baseCost: 5, type: "crit", icon: "ğŸ’¥", max: 50 },
    'art_crit_dmg': { name_ja: "åæŸãƒ¬ãƒ³ã‚º", name_en: "Focusing Lens", desc_ja: "ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«å€ç‡", desc_en: "Crit Multiplier", baseCost: 8, type: "crit_dmg", icon: "ğŸ”" },
    'art_relic':    { name_ja: "å¤ä»£ã®ã‚³ãƒ³ãƒ‘ã‚¹", name_en: "Ancient Compass", desc_ja: "ãƒ¬ãƒªãƒƒã‚¯ç²å¾—UP", desc_en: "Relic Gain UP", baseCost: 15, type: "relic_boost", icon: "ğŸ§­" },
    'art_auto_click': { name_ja: "ã‚ªãƒ¼ãƒˆã‚¯ãƒªãƒƒã‚«ãƒ¼", name_en: "Auto-Clicker", desc_ja: "è‡ªå‹•ã‚¯ãƒªãƒƒã‚¯", desc_en: "Auto Click", baseCost: 100, type: "auto_click", icon: "ğŸ–±ï¸" },
    'art_force_link': { name_ja: "ãƒ•ã‚©ãƒ¼ã‚¹ãƒ»ãƒªãƒ³ã‚¯", name_en: "Force Link", desc_ja: "ç§’é–“åå…¥ã‚’ã‚¯ãƒªãƒƒã‚¯åŠ›ã«åŠ ç®—", desc_en: "Link Income to Click Power", baseCost: 500, type: "force_link", icon: "ğŸ”—" }
};

const UNIQUE_DATA = {
    'u_batch':      { name_ja: "ä¸€æ‹¬åˆ¶å¾¡ã‚·ã‚¹ãƒ†ãƒ ", name_en: "Batch System", max: 4, baseCost: 10, desc_ja: "è³¼å…¥é‡å¤‰æ›´ã‚’è§£æ”¾", desc_en: "Unlock Purchase Multipliers", icon: "ğŸ“¦" },
    'u_claim_all':  { name_ja: "è‡ªå‹•ç®¡ç†AI", name_en: "Admin AI", max: 1, baseCost: 100, desc_ja: "ãƒãƒ£ãƒ¬ãƒ³ã‚¸å ±é…¬ä¸€æ‹¬å—ã‘å–ã‚Šã‚’è§£æ”¾", desc_en: "Unlock Claim All Rewards", icon: "ğŸ¤–" },
    'u_auto_buy':   { name_ja: "è‡ªå‹•æ§‹ç¯‰ã‚¢ãƒ¼ãƒ ", name_en: "Auto-Build Arm", max: Object.keys(MODULE_DATA).length, baseCost: 50, desc_ja: "ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«è‡ªå‹•è³¼å…¥ã‚’ä¸Šã‹ã‚‰é †ã«è§£æ”¾", desc_en: "Unlock Auto-Buyer Modules", icon: "âš™ï¸" }
};

const ADVANCED_DATA = {
    'adv_time':     { name_ja: "æ™‚é–“åŠ é€Ÿè£…ç½®", name_en: "Time Accelerator", baseCost: 1, desc_ja: "ã‚²ãƒ¼ãƒ ã‚¹ãƒ”ãƒ¼ãƒ‰ x1.5 (ä¹—ç®—)", desc_en: "Game Speed x1.5 (Mult)", icon: "â©" },
    'adv_relic':    { name_ja: "ãƒ¬ãƒªãƒƒã‚¯å¢—å¹…å™¨", name_en: "Relic Expander", baseCost: 1, desc_ja: "ãƒ¬ãƒªãƒƒã‚¯ç²å¾—é‡ x2.0 (ä¹—ç®—)", desc_en: "Relic Gain x2.0 (Mult)", icon: "ğŸ’" },
    'adv_core':     { name_ja: "ã‚¢ãƒ«ãƒ•ã‚¡ãƒ»ã‚³ã‚¢", name_en: "Alpha Core", baseCost: 1, desc_ja: "æœ€çµ‚ç”Ÿç”£å€ç‡ x2.0 (ä¹—ç®—)", desc_en: "Final Prod. x2.0 (Mult)", icon: "âš›ï¸" },
    'adv_perm_batch': { name_ja: "ä¸€æ‹¬åˆ¶å¾¡ã®æ°¸ç¶šåŒ–", name_en: "Perm. Batch", baseCost: 1, max: 1, desc_ja: "è»¢ç”Ÿæ™‚ã«ã€Œä¸€æ‹¬åˆ¶å¾¡ã‚·ã‚¹ãƒ†ãƒ ã€ã‚’æœ€å¤§Lvã§ç¶­æŒ", desc_en: "Keep Max Batch after Reset", icon: "ğŸ’¾" },
    'adv_perm_admin': { name_ja: "ç®¡ç†AIã®æ°¸ç¶šåŒ–", name_en: "Perm. Admin", baseCost: 1, max: 1, desc_ja: "è»¢ç”Ÿæ™‚ã«ã€Œè‡ªå‹•ç®¡ç†AIã€ã‚’æœ€å¤§Lvã§ç¶­æŒ", desc_en: "Keep Max Admin AI after Reset", icon: "ğŸ’¾" },
    'adv_perm_auto':  { name_ja: "è‡ªå‹•æ§‹ç¯‰ã®æ°¸ç¶šåŒ–", name_en: "Perm. Auto", baseCost: 1, max: 1, desc_ja: "è»¢ç”Ÿæ™‚ã«ã€Œè‡ªå‹•æ§‹ç¯‰ã‚¢ãƒ¼ãƒ ã€ã‚’æœ€å¤§Lvã§ç¶­æŒ", desc_en: "Keep Max Auto-Build after Reset", icon: "ğŸ’¾" }
};

const CHALLENGE_DEFS = {
    click: { category:'stat', desc_ja: "ç´¯è¨ˆã‚¯ãƒªãƒƒã‚¯æ•°", desc_en: "Total Clicks", key: 'totalClicks', baseTarget: 1000, scale: 2.5, rewardBase: 0.02, order: 1 }, 
    stage: { category:'stat', desc_ja: "åˆ°é”ãƒ•ã‚§ãƒ¼ã‚º", desc_en: "Max Phase", key: 'currentStage', baseTarget: 2, scale: 1.2, rewardBase: 0.10, isPhase: true, order: 2 },
    prestige: { category:'stat', desc_ja: "ç´¯è¨ˆè»¢ç”Ÿå›æ•°", desc_en: "Total Prestige", key: 'prestigeCount', baseTarget: 1, scale: 2, rewardBase: 0.05, order: 3 },
    relics: { category:'stat', desc_ja: "æ‰€æŒãƒ¬ãƒªãƒƒã‚¯æ•°", desc_en: "Relics Owned", key: 'relics', baseTarget: 10, scale: 3, rewardBase: 0.02, order: 4 }, 
    transcend: { category:'stat', desc_ja: "ç´¯è¨ˆè¶…è¶Šå›æ•°", desc_en: "Total Transcend", key: 'transcendCount', baseTarget: 1, scale: 2, rewardBase: 0.20, order: 5 },
    apotheosis: { category:'stat', desc_ja: "çœŸåŒ–å›æ•°", desc_en: "Total Apotheosis", key: 'apotheosisCount', baseTarget: 1, mode: 'linear', rewardBase: 0.50, order: 6 }
};

let mOrder = 10;
for(let k in MODULE_DATA) {
    CHALLENGE_DEFS[`mod_${k}`] = {
        category: 'module', desc_ja: `${MODULE_DATA[k].name_ja} Lv`, desc_en: `${MODULE_DATA[k].name_en} Lv`, key: k, isModule: true, baseTarget: 50, mode: 'step', rewardBase: 2, order: mOrder++
    };
}
let uOrder = 200;
for(let k in UNIQUE_DATA) {
    CHALLENGE_DEFS[`unique_${k}`] = {
        category: 'unique', desc_ja: `${UNIQUE_DATA[k].name_ja} Lv`, desc_en: `${UNIQUE_DATA[k].name_en} Lv`, key: k, isUnique: true, baseTarget: 1, scale: 1, rewardBase: 0.15, mode: 'linear', order: uOrder++
    };
}
let aOrder = 100;
for(let k in ARTIFACT_DATA) {
    CHALLENGE_DEFS[`art_${k}`] = {
        category: 'artifact', desc_ja: `${ARTIFACT_DATA[k].name_ja} Lv`, desc_en: `${ARTIFACT_DATA[k].name_en} Lv`, key: k, isArtifact: true, baseTarget: 5, scale: 1.5, rewardBase: 0.03, order: aOrder++
    };
}
let advOrder = 300;
for(let k in ADVANCED_DATA) {
    CHALLENGE_DEFS[`adv_${k}`] = {
        category: 'advanced', desc_ja: `${ADVANCED_DATA[k].name_ja} Lv`, desc_en: `${ADVANCED_DATA[k].name_en} Lv`, key: k, isAdvanced: true, baseTarget: 1, scale: 1, rewardBase: 0.25, mode: 'linear', order: advOrder++
    };
}

let game = {
    score: 0, totalScore: 0, relics: 0, ether: 0,
    prestigeCount: 0, transcendCount: 0, apotheosisCount: 0,
    skinSettings: {
        mode: 'auto',
        manualColor: 'auto', // â˜… 10 ã‹ã‚‰ 'auto' ã«å¤‰æ›´
        manualShape: 'auto'   // â˜… 10 ã‹ã‚‰ 'auto' ã«å¤‰æ›´
    },
    startTime: Date.now(), currentStage: 0,
    upgrades: {}, artifacts: {}, uniqueArtifacts: {}, advancedArtifacts: {},
    stats: { 
        totalClicks: 0,
        maxStage: 0,
        maxRelics: 0,
        totalPrestige: 0,
        maxModules: {},
        maxArtifacts: {},
        maxUnique: {},
        maxAdvanced: {}
    }, 
    challengeTiers: {}, seenModules: {}, autoBuyToggles: {},
    settings: {
        particles: 'high',
        bloom: true,
        blur: true,
        numbers: true,
        bgColor: true,
        lang: 'ja'
    }
};
let tabScrollStates = {};
let buyMode = 1;
for(let k in MODULE_DATA) { game.upgrades[k] = { count: 0 }; game.autoBuyToggles[k] = false; game.stats.maxModules[k] = 0; }
for(let k in ARTIFACT_DATA) { game.artifacts[k] = 0; game.stats.maxArtifacts[k] = 0; }
for(let k in UNIQUE_DATA) { game.uniqueArtifacts[k] = 0; game.stats.maxUnique[k] = 0; }
for(let k in ADVANCED_DATA) { game.advancedArtifacts[k] = 0; game.stats.maxAdvanced[k] = 0; }
for(let k in CHALLENGE_DEFS) game.challengeTiers[k] = 1;

let particles = [];
const canvas = document.getElementById('particleCanvas');
const ctx = canvas.getContext('2d');
let lastTime = Date.now();
let autoClickAccumulator = 0;

function init() {
    loadGame();
    initUI();
    applyGraphicsSettings(); 
    resizeCanvas();
    updateStageConfig(true);
    setBuyMode(game.settings.buyMode || 1);
    
    window.addEventListener('resize', resizeCanvas);
    document.getElementById('reactor-wrapper').addEventListener('mousedown', handleClick);
    
    document.addEventListener('keydown', (e) => {
        if (e.code === 'Enter') {
            e.preventDefault(); // â˜…é‡è¦ï¼šãƒœã‚¿ãƒ³ã¸ã®ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã«ã‚ˆã‚‹èª¤ä½œå‹•ï¼ˆæ¨™æº–å‹•ä½œï¼‰ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã™ã‚‹
            
            if (!e.repeat) { // é•·æŠ¼ã—ã«ã‚ˆã‚‹é€£æ‰“ï¼ˆãƒªãƒ”ãƒ¼ãƒˆï¼‰ã‚’é˜²æ­¢
                const rect = document.getElementById('reactor-wrapper').getBoundingClientRect();
                handleClick({ clientX: rect.left+rect.width/2, clientY: rect.top+rect.height/2 });
                const wrap = document.getElementById('reactor-wrapper');
                wrap.style.transform = "scale(0.95)";
                setTimeout(() => wrap.style.transform = "scale(1)", 50);
            }
        }
    });

    updateUI();
    restoreScrollPositions();
    requestAnimationFrame(gameLoop);
    setInterval(saveGame, 5000);
    setInterval(updateUI, 100); 
}

function updateGraphics(key, value) {
    game.settings[key] = value;
    applyGraphicsSettings();
    if(key === 'bgColor') updateStageConfig();
    if(key === 'lang') {
        initUI(); // è¨€èªå¤‰æ›´æ™‚ã¯UIã‚’å†æ§‹ç¯‰
        updateUI();
    }
}
function toggleModal(show) {
    const modal = document.getElementById('modal-overlay');
    if (show) {
        modal.style.display = 'flex';
        // è¨­å®šå€¤ã®è¡¨ç¤ºã‚’æœ€æ–°çŠ¶æ…‹ã«æ›´æ–°
        applyGraphicsSettings();
    } else {
        modal.style.display = 'none';
    }
}

function applyGraphicsSettings() {
    if (!game.settings.bloom) {
        document.body.classList.add('low-perf');
    } else {
        document.body.classList.remove('low-perf');
    }

    if (!game.settings.blur) {
        document.body.classList.add('no-blur');
    } else {
        document.body.classList.remove('no-blur');
    }

    document.getElementById('set-particles').value = game.settings.particles;
    document.getElementById('set-bloom').checked = game.settings.bloom;
    document.getElementById('set-blur').checked = game.settings.blur;
    document.getElementById('set-numbers').checked = game.settings.numbers;
    const confirmCheck = document.getElementById('set-confirm');
    if(confirmCheck) confirmCheck.checked = game.settings.confirmations;
    document.getElementById('set-lang').value = game.settings.lang || 'ja';
    
    const bgCheck = document.getElementById('set-bg-color');
    if(bgCheck) bgCheck.checked = game.settings.bgColor;

    // UIãƒ†ã‚­ã‚¹ãƒˆç¿»è¨³ã®æ›´æ–°
    const L = LANG_DATA[game.settings.lang] || LANG_DATA.ja;
    document.getElementById('ui-graphics-title').innerText = L.graphicsTitle;
    document.getElementById('ui-label-particles').innerText = L.labelParticles;
    document.getElementById('ui-label-bloom').innerText = L.labelBloom;
    document.getElementById('ui-label-blur').innerText = L.labelBlur;
    document.getElementById('ui-label-bgcolor').innerText = L.labelBgColor;
    document.getElementById('ui-label-numbers').innerText = L.labelNumbers;
    const labelConfirm = document.getElementById('ui-label-confirm');
    if(labelConfirm) labelConfirm.innerText = L.labelConfirm;
    document.getElementById('ui-label-lang').innerText = L.labelLang;
    document.getElementById('ui-data-title').innerText = L.dataTitle;
    document.getElementById('ui-system-title').innerText = L.systemTitle;
    document.getElementById('ui-save-desc').innerText = L.saveDesc;
    document.getElementById('ui-reset-desc').innerText = L.resetDesc;
    document.getElementById('ui-btn-delete').innerText = L.btnDelete;
    document.getElementById('ui-module-header').innerText = L.moduleHeader;
    document.getElementById('ui-tab-system').innerText = L.tabSystem;
    document.getElementById('ui-tab-challenges').innerText = L.tabChallenges;
    document.getElementById('ui-label-mult').innerText = L.labelMult;
    document.getElementById('ui-label-bonus').innerText = L.labelBonus;
    document.getElementById('ui-label-relic').innerText = L.labelRelic;
    document.getElementById('ui-label-ether').innerText = L.labelEther;
    document.getElementById('ui-label-clicks').innerText = L.labelClicks;
    document.getElementById('ui-label-prestige-count').innerText = L.labelPrestigeCount;
    document.getElementById('ui-label-transcend-count').innerText = L.labelTranscendCount;
    document.getElementById('ui-label-apotheosis-count').innerText = L.labelApotheosisCount;
    document.getElementById('ui-label-online').innerText = L.labelOnline;
    document.getElementById('ui-prestige-desc').innerText = L.prestigeDesc;
    document.getElementById('ui-transcend-desc').innerHTML = L.transcendDesc;
    document.getElementById('ui-apotheosis-desc').innerHTML = L.apotheosisDesc;
    document.getElementById('ui-unique-header').innerText = L.uniqueHeader;
    document.getElementById('ui-standard-header').innerText = L.standardHeader;
    document.getElementById('ui-advanced-header').innerText = L.advancedHeader;
    document.getElementById('ui-label-global-bonus').innerText = L.labelGlobalBonus;
    document.getElementById('ui-chal-note').innerText = L.chalNote;

    const skinTitle = document.getElementById('skin-menu-title');
    if(skinTitle) skinTitle.innerText = L.skinMenuTitle;
    const skinColorLabel = document.getElementById('skin-label-color');
    if(skinColorLabel) skinColorLabel.innerText = L.labelSkinColor;
    const skinShapeLabel = document.getElementById('skin-label-shape');
    if(skinShapeLabel) skinShapeLabel.innerText = L.labelSkinShape;
}

function exportSave() {
    saveGame();
    const json = JSON.stringify(game);
    const base64 = btoa(unescape(encodeURIComponent(json)));
    navigator.clipboard.writeText(base64).then(() => {
        spawnFloater(window.innerWidth / 2, window.innerHeight / 2, "COPIED TO CLIPBOARD!", true);
    }).catch(err => {
        prompt("COPY THIS CODE:", base64);
    });
}

function importSave() {
    const data = prompt("PASTE SAVE CODE:");
    if (!data) return;
    try {
        const json = decodeURIComponent(escape(atob(data)));
        const parsed = JSON.parse(json);
        if (parsed.score !== undefined) {
            fixGameData(parsed); 
            saveGame();
            location.reload();
        } else {
            alert("INVALID SAVE DATA");
        }
    } catch (e) {
        alert("IMPORT FAILED");
    }
}

function checkMaxStats() {
    const currentMaxStage = game.stats.maxStage || 0;
    if (game.currentStage > currentMaxStage) game.stats.maxStage = game.currentStage;

    const currentMaxRelics = game.stats.maxRelics || 0;
    if (game.relics > currentMaxRelics) game.stats.maxRelics = game.relics;
    
    if(!game.stats.maxModules) game.stats.maxModules = {};
    for(let k in game.upgrades) {
        const currentMax = game.stats.maxModules[k] || 0;
        if (game.upgrades[k].count > currentMax) {
            game.stats.maxModules[k] = game.upgrades[k].count;
        }
    }

    if(!game.stats.maxArtifacts) game.stats.maxArtifacts = {};
    for(let k in game.artifacts) {
        const currentMax = game.stats.maxArtifacts[k] || 0;
        if (game.artifacts[k] > currentMax) {
            game.stats.maxArtifacts[k] = game.artifacts[k];
        }
    }

    if(!game.stats.maxUnique) game.stats.maxUnique = {};
    for(let k in game.uniqueArtifacts) {
        const currentMax = game.stats.maxUnique[k] || 0;
        if (game.uniqueArtifacts[k] > currentMax) {
            game.stats.maxUnique[k] = game.uniqueArtifacts[k];
        }
    }

    if(!game.stats.maxAdvanced) game.stats.maxAdvanced = {};
    for(let k in game.advancedArtifacts) {
        const currentMax = game.stats.maxAdvanced[k] || 0;
        if (game.advancedArtifacts[k] > currentMax) {
            game.stats.maxAdvanced[k] = game.advancedArtifacts[k];
        }
    }
}

function handleClick(e) {
    game.stats.totalClicks++;
    const wrap = document.getElementById('reactor-wrapper');
    wrap.style.transform = "scale(0.95)";
    setTimeout(() => wrap.style.transform = "scale(1)", 50);

    let val = getClickPower();
    if (isNaN(val) || val <= 0) val = 1; 

    const critChance = getArtifactEffectValue('art_crit', game.artifacts.art_crit);
    const critMult = getArtifactEffectValue('art_crit_dmg', game.artifacts.art_crit_dmg);
    let isCrit = false;
    
    if (Math.random() < critChance) {
        val *= critMult;
        isCrit = true;
    }

    addScore(val);
    if(game.settings.numbers) {
        spawnFloater(e.clientX, e.clientY, `+${formatNumber(val)}`, isCrit);
    }
}

function getStageConfig(stageIndex) {
    const phase = stageIndex + 1;
    let defIndex;
    let shapeIndex;

    // é€²è¡Œåº¦ã«åŸºã¥ã„ãŸæœ¬æ¥ã®æ•°å€¤ï¼ˆAutoç”¨ï¼‰
    const autoDefIndex = (phase >= 101) ? 10 : (phase - 1) % 10;
    const autoShapeIndex = (phase >= 101) ? 10 : Math.floor((phase - 1) / 10);

    // Colorã®æ±ºå®šï¼š'auto'ã¨ã„ã†æ–‡å­—åˆ—ã‚’å³å¯†ã«ãƒã‚§ãƒƒã‚¯
    if (!game.skinSettings || game.skinSettings.manualColor === 'auto' || game.skinSettings.manualColor === undefined) {
        defIndex = autoDefIndex;
    } else {
        defIndex = parseInt(game.skinSettings.manualColor);
    }

    // Shapeã®æ±ºå®šï¼š'auto'ã¨ã„ã†æ–‡å­—åˆ—ã‚’å³å¯†ã«ãƒã‚§ãƒƒã‚¯
    if (!game.skinSettings || game.skinSettings.manualShape === 'auto' || game.skinSettings.manualShape === undefined) {
        shapeIndex = autoShapeIndex;
    } else {
        shapeIndex = parseInt(game.skinSettings.manualShape);
    }

    // æ•°å€¤å¤‰æ›ã«å¤±æ•—ã—ãŸå ´åˆã®ä¿é™º
    if (isNaN(defIndex)) defIndex = autoDefIndex;
    if (isNaN(shapeIndex)) shapeIndex = autoShapeIndex;

    // ç¯„å›²å¤–ã‚¨ãƒ©ãƒ¼é˜²æ­¢
    if (defIndex >= STAGE_DEFS.length) defIndex = STAGE_DEFS.length - 1;
    if (shapeIndex >= CYCLE_SHAPE_CLASSES.length) shapeIndex = CYCLE_SHAPE_CLASSES.length - 1;

    const def = STAGE_DEFS[defIndex];
    const shapeClass = CYCLE_SHAPE_CLASSES[shapeIndex];

    return { 
        ...def, 
        cycle: shapeIndex,
        displayName: `Phase ${phase}`, 
        shapeClass: shapeClass
    };
}

function getStageThreshold(stageIndex) {
    if (stageIndex === 0) return 0;
    if (stageIndex === 1) return 3000000;
    return 3000000 * Math.pow(13, stageIndex - 1);
}

function getArtifactEffectValue(key, level) {
    level = level || 0;
    if(key === 'art_power') return 1 + (level * 0.5);
    if(key === 'art_cost') return Math.pow(0.92, level);
    if(key === 'art_crit') return level * 0.02;
    if(key === 'art_crit_dmg') return 5 + (level * 1.0);
    if(key === 'art_relic') return 1 + (level * 0.25);
    if(key === 'art_auto_click') return level * 1;
    if(key === 'art_force_link') return level * 0.005;
    return 0;
}

function getArtifactEffectString(key, level) {
    if(key === 'art_power') return `x${getArtifactEffectValue(key, level).toFixed(2)}`;
    if(key === 'art_cost') return `x${getArtifactEffectValue(key, level).toFixed(2)} Cost`;
    if(key === 'art_crit') return `${(getArtifactEffectValue(key, level)*100).toFixed(0)}%`;
    if(key === 'art_crit_dmg') return `x${getArtifactEffectValue(key, level).toFixed(1)}`;
    if(key === 'art_relic') return `x${getArtifactEffectValue(key, level).toFixed(2)}`;
    if(key === 'art_auto_click') return `+${level}/sec`;
    if(key === 'art_force_link') return `+${(level*0.5).toFixed(1)}% Income`;
    return "";
}

function getGlobalChallengeMultiplier() {
    let mult = 1.0;
    for (let k in CHALLENGE_DEFS) {
        const def = CHALLENGE_DEFS[k];
        if (def.category !== 'module') {
            const tier = game.challengeTiers[k] || 1;
            mult += (tier - 1) * def.rewardBase;
        }
    }
    return mult;
}

function getModuleChallengeMultiplier(moduleKey) {
    const chalKey = `mod_${moduleKey}`;
    const def = CHALLENGE_DEFS[chalKey];
    if (!def) return 1.0;
    const tier = game.challengeTiers[chalKey] || 1;
    return Math.pow(2, tier - 1);
}

function getAdvancedMultiplier() { return Math.pow(2.0, game.advancedArtifacts.adv_core); }
function getTimeSpeed() { return Math.pow(1.5, game.advancedArtifacts.adv_time); }

function getApotheosisMult() {
    return 1;
}
function getTranscendReq() {
    // åˆå›ã¯50,000ã€‚ä»¥é™ã€å›æ•°ã«å¿œã˜ã¦5å€ãšã¤å¢—ãˆã‚‹
    return 50000 * Math.pow(5, game.transcendCount);
}
function getApotheosisReq() {
    return 20 + (game.apotheosisCount * 10);
}
function getApotheosisStartBonus() {
    // çœŸåŒ–å›æ•° 1å›ã«ã¤ã +10 ã®åˆæœŸãƒªã‚½ãƒ¼ã‚¹ã‚’ä¸ãˆã‚‹
    // (ä¾‹: 1å›ç›®=10, 2å›ç›®=20...)
    if (game.apotheosisCount === 0) return 0;
    return game.apotheosisCount * 10;
}
function getApotheosisScoreBonus() {
    return 0;
}

function getGlobalMultipliers() {
    let art = getArtifactEffectValue('art_power', game.artifacts.art_power);
    let stage = Math.pow(1.5, game.currentStage);
    let globalChal = getGlobalChallengeMultiplier();
    let adv = getAdvancedMultiplier();
    return art * stage * globalChal * adv;
}

function getClickPower() {
    let base = 1 + (game.upgrades.cursor.count * MODULE_DATA.cursor.power);
    base *= getModuleChallengeMultiplier('cursor');
    base *= getGlobalMultipliers();
    const linkBoost = getArtifactEffectValue('art_force_link', game.artifacts.art_force_link);
    if (linkBoost > 0) base += getAutoIncome() * linkBoost;
    return base;
}

function getAutoIncome() {
    let income = 0;
    for(let k in game.upgrades) {
        if(k !== 'cursor') {
            let modPower = game.upgrades[k].count * MODULE_DATA[k].power;
            modPower *= getModuleChallengeMultiplier(k);
            income += modPower;
        }
    }
    return income * getGlobalMultipliers();
}

function getBulkModuleCost(key, amountToBuy) {
    const currentCount = game.upgrades[key].count;
    const base = MODULE_DATA[key].baseCost;
    const r = 1.15;
    const discount = getArtifactEffectValue('art_cost', game.artifacts.art_cost);
    let n = amountToBuy;
    let cost = 0;
    if (amountToBuy === -1) {
        const priceStart = base * Math.pow(r, currentCount) * discount;
        if (priceStart > game.score) return { cost: priceStart, count: 0 };
        const maxAffordable = Math.floor( Math.log(1 + (game.score * (r - 1) / priceStart)) / Math.log(r) );
        n = Math.max(1, maxAffordable);
    }
    const startCost = base * Math.pow(r, currentCount);
    cost = Math.floor( startCost * (Math.pow(r, n) - 1) / (r - 1) * discount );
    if (amountToBuy === -1 && cost > game.score) {
        while(cost > game.score && n > 0) { n--; cost = Math.floor(startCost * (Math.pow(r, n) - 1) / (r - 1) * discount); }
    }
    if (isNaN(cost) || cost < 0) cost = Infinity; // ã‚¨ãƒ©ãƒ¼æ™‚ã¯è³¼å…¥ä¸å¯ã«ã™ã‚‹
    if (isNaN(n) || n < 0) n = 0;
    
    return { cost: cost, count: n };
}

function getBulkArtifactCost(key, amountToBuy) {
    const level = game.artifacts[key];
    const def = ARTIFACT_DATA[key];
    const base = def.baseCost;
    const r = 1.6;
    let maxLevel = def.max || Infinity;

    if (level >= maxLevel) return { cost: 0, count: 0 };

    let n = amountToBuy;
    let cost = 0;
    
    if (amountToBuy === -1) {
        const priceStart = base * Math.pow(r, level);
        if (priceStart > game.relics) return { cost: priceStart, count: 0 };
        const maxAffordable = Math.floor( Math.log(1 + (game.relics * (r - 1) / priceStart)) / Math.log(r) );
        n = Math.max(1, maxAffordable);
        if (level + n > maxLevel) n = maxLevel - level;
    } else {
        if (level + n > maxLevel) n = maxLevel - level;
    }

    if (n <= 0) return { cost: 0, count: 0 };

    const startCost = base * Math.pow(r, level);
    cost = Math.floor( startCost * (Math.pow(r, n) - 1) / (r - 1) );
    return { cost: cost, count: n };
}

function getUniqueArtifactCost(key) {
    const level = game.uniqueArtifacts[key];
    if (level >= UNIQUE_DATA[key].max) return Infinity;
    if (key === 'u_batch') { 
        const costs = [10, 50, 200, 2000]; 
        return costs[level]; 
    }
    return Math.floor(UNIQUE_DATA[key].baseCost * Math.pow(3, level));
}

function getBulkAdvancedArtifactCost(key, amountToBuy) {
    const def = ADVANCED_DATA[key];
    const currentLevel = game.advancedArtifacts[key] || 0;
    const maxLevel = def.max || Infinity;
    const baseCost = 1; // ç¾åœ¨ã€è¶…è¶Šã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã®ã‚³ã‚¹ãƒˆã¯ä¸€å¾‹1ã‚¨ãƒ¼ãƒ†ãƒ«

    // æ—¢ã«æœ€å¤§ãƒ¬ãƒ™ãƒ«ãªã‚‰è³¼å…¥ä¸å¯
    if (currentLevel >= maxLevel) return { cost: 0, count: 0 };

    let n = amountToBuy;

    // MAXè³¼å…¥ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆ
    if (amountToBuy === -1) {
        // æ‰€æŒã‚¨ãƒ¼ãƒ†ãƒ«ã§è²·ãˆã‚‹ã ã‘è²·ã†
        let affordable = Math.floor(game.ether / baseCost);
        n = affordable;
        // ä¸Šé™ãŒã‚ã‚‹å ´åˆã¯ã‚­ãƒ£ãƒƒãƒ—ã™ã‚‹
        if (currentLevel + n > maxLevel) {
            n = maxLevel - currentLevel;
        }
    } else {
        // æŒ‡å®šæ•°(x5, x10)è³¼å…¥ã®å ´åˆã‚‚ä¸Šé™ã‚’è¶…ãˆãªã„ã‚ˆã†ã«ã™ã‚‹
        if (currentLevel + n > maxLevel) {
            n = maxLevel - currentLevel;
        }
    }

    // è³¼å…¥æ•°ãŒ0ä»¥ä¸‹ï¼ˆã‚¨ãƒ¼ãƒ†ãƒ«ä¸è¶³ã‚„æœ€å¤§ãƒ¬ãƒ™ãƒ«åˆ°é”ï¼‰
    if (n <= 0) return { cost: 0, count: 0 };

    // ã‚³ã‚¹ãƒˆè¨ˆç®—
    const totalCost = n * baseCost;

    return { cost: totalCost, count: n };
}

function addScore(amt) {
    if (isNaN(amt)) amt = 0;
    game.score += amt; game.totalScore += amt;
    checkStageProgress();
    checkMaxStats();
}

function checkStageProgress() {
    const nextThreshold = getStageThreshold(game.currentStage + 1);
    if (game.totalScore >= nextThreshold) {
        game.currentStage++; updateStageConfig();
    }
}

function calculateRelicGain() {
    if (game.totalScore < PRESTIGE_THRESHOLD) return 0;
    let baseGain = Math.floor(Math.pow(5, game.currentStage));
    let artBonus = getArtifactEffectValue('art_relic', game.artifacts.art_relic);
    let advBonus = Math.pow(2.0, game.advancedArtifacts.adv_relic);

    return Math.floor(baseGain * artBonus * advBonus);
}

function setBuyMode(mode) {
    buyMode = mode;
    if(game.settings) {
        game.settings.buyMode = mode;
    }
    const btns = document.querySelectorAll('.buy-btn');
    btns.forEach(b => {
        b.classList.remove('active');
        if(b.innerText === (mode === -1 ? 'MAX' : 'x'+mode)) b.classList.add('active');
    });
    updateUI();
}

function toggleAutoBuy(key) { game.autoBuyToggles[key] = !game.autoBuyToggles[key]; updateUI(); }

function initUI() {
    const lang = game.settings.lang || 'ja';
    const uList = document.getElementById('upgrade-list');
    uList.innerHTML = '';
    for(let k in MODULE_DATA) {
        const name = lang === 'ja' ? MODULE_DATA[k].name_ja : MODULE_DATA[k].name_en;
        const btn = document.createElement('div');
        btn.className = 'btn-upgrade clickable';
        btn.id = `btn-${k}`;
        btn.onclick = (e) => { if(!e.target.closest('.toggle-switch')) buyUpgrade(k); };
        btn.innerHTML = `
            <div class="auto-buy-wrapper" id="ab-wrap-${k}" style="display:none;">
                <span class="toggle-label">AUTO</span>
                <div class="toggle-switch" id="ab-toggle-${k}" onclick="toggleAutoBuy('${k}')"></div>
            </div>
            <div class="btn-row">
                <span class="item-name">${name}</span>
                <span class="cost-text" id="cost-${k}">0</span>
            </div>
            <div class="btn-row">
                <span class="item-lvl" style="color:#aaa; font-size:0.8rem;">Lv.<span id="lv-${k}">0</span></span>
            </div>
            <div class="effect-row">
                <span id="eff-curr-${k}" class="val-curr">0</span>
                <span class="arrow">â†’</span>
                <span id="eff-next-${k}" class="val-next">0</span>
            </div>
        `;
        uList.appendChild(btn);
    }

    const aList = document.getElementById('artifact-list');
    aList.innerHTML = '';
    for(let k in ARTIFACT_DATA) {
        const name = lang === 'ja' ? ARTIFACT_DATA[k].name_ja : ARTIFACT_DATA[k].name_en;
        const desc = lang === 'ja' ? ARTIFACT_DATA[k].desc_ja : ARTIFACT_DATA[k].desc_en;
        const div = document.createElement('div');
        div.className = 'artifact-card normal clickable';
        div.onclick = () => buyArtifact(k);
        div.id = `art-btn-${k}`;
        div.innerHTML = `
            <div class="btn-row">
                <span style="font-weight:bold; color:#fff;">${ARTIFACT_DATA[k].icon} ${name}</span>
                <span style="font-size:0.8em; color:var(--theme-color);">Lv.<span id="art-lv-${k}">0</span></span>
            </div>
            <div style="font-size:0.75rem; color:#ccc; margin:4px 0;">${desc}</div>
            <div class="effect-row">
                <span id="art-eff-curr-${k}" class="val-curr"></span>
                <span class="arrow">â†’</span>
                <span id="art-eff-next-${k}" class="val-next"></span>
            </div>
            <div class="btn-row" style="margin-top:5px;">
                <span></span>
                <span style="font-size:0.8rem;">Cost: <span class="relic-text" id="art-cost-${k}">0</span></span>
            </div>
        `;
        aList.appendChild(div);
    }

    const uArtList = document.getElementById('unique-list');
    uArtList.innerHTML = '';
    for(let k in UNIQUE_DATA) {
        const name = lang === 'ja' ? UNIQUE_DATA[k].name_ja : UNIQUE_DATA[k].name_en;
        const desc = lang === 'ja' ? UNIQUE_DATA[k].desc_ja : UNIQUE_DATA[k].desc_en;
        const div = document.createElement('div');
        div.className = 'unique-card clickable';
        div.onclick = () => buyUniqueArtifact(k);
        div.id = `unique-btn-${k}`;
        div.innerHTML = `
            <div class="btn-row">
                <span style="font-weight:bold; color:#fff;">${UNIQUE_DATA[k].icon} ${name}</span>
                <span style="font-size:0.8em; color:var(--unique);">Lv.<span id="u-lv-${k}">0</span> / ${UNIQUE_DATA[k].max}</span>
            </div>
            <div style="font-size:0.75rem; color:#ccc; margin:4px 0;">${desc}</div>
            <div class="btn-row" style="margin-top:5px;">
                <span></span>
                <span style="font-size:0.8rem;">Cost: <span class="relic-text" id="u-cost-${k}">0</span></span>
            </div>
        `;
        uArtList.appendChild(div);
    }

    const advList = document.getElementById('advanced-list');
    advList.innerHTML = '';
    for(let k in ADVANCED_DATA) {
        const name = lang === 'ja' ? ADVANCED_DATA[k].name_ja : ADVANCED_DATA[k].name_en;
        const desc = lang === 'ja' ? ADVANCED_DATA[k].desc_ja : ADVANCED_DATA[k].desc_en;
        const div = document.createElement('div');
        div.className = 'artifact-card ether clickable';
        div.onclick = () => buyAdvancedArtifact(k);
        div.id = `adv-btn-${k}`;
        div.innerHTML = `
            <div class="btn-row">
                <span style="font-weight:bold; color:#fff;">${ADVANCED_DATA[k].icon} ${name}</span>
                <span style="font-size:0.8em; color:var(--ether);">Lv.<span id="adv-lv-${k}">0</span></span>
            </div>
            <div style="font-size:0.75rem; color:#ccc; margin:4px 0;">${desc}</div>
            <div class="btn-row" style="margin-top:5px;">
                <span></span>
                <span style="font-size:0.8rem;">Cost: <span class="ether-text" id="adv-cost-${k}">0</span></span>
            </div>
        `;
        advList.appendChild(div);
    }
    updateChallengesUI();
}

function updateUI() {
    checkMaxStats(); 
    document.getElementById('score-display').innerText = formatNumber(Math.floor(game.score));
    document.getElementById('mps-display').innerText = formatNumber(Math.floor(getAutoIncome())) + " / sec";
    const globalMult = getGlobalMultipliers();

    const showArtifacts = (game.prestigeCount > 0) || (game.stats.totalPrestige > 0) || (game.transcendCount > 0);
    if(showArtifacts) document.getElementById('tab-btn-artifacts').style.display = 'block';

    const tReq = getTranscendReq();
    const hasTranscendHistory = game.transcendCount > 0 || game.stats.totalTranscend > 0 || game.apotheosisCount > 0;
    if(game.relics >= 50000 || hasTranscendHistory) {
        document.getElementById('btn-transcend').style.display = 'block';
    } else {
        document.getElementById('btn-transcend').style.display = 'none';
    }
    if(hasTranscendHistory) {
        document.getElementById('tab-btn-transcend').style.display = 'block';
    } else {
        document.getElementById('tab-btn-transcend').style.display = 'none';
    }

    const apoReq = getApotheosisReq();
    const nextCount = game.apotheosisCount + 1;
    const nextOther = nextCount * 10;
    if (game.currentStage + 1 >= 20 || game.apotheosisCount > 0) {
        const btnApo = document.getElementById('btn-apotheosis');
        btnApo.style.display = 'block';
        document.getElementById('apotheosis-req').innerText = `REQ: Phase ${apoReq}`;
        document.getElementById('apotheosis-gain').innerText = `NEXT: Start +${nextOther} Ether`;
        
        if (game.currentStage + 1 >= apoReq) {
            btnApo.disabled = false;
        } else {
            btnApo.disabled = true;
        }
    }

    const hasTranscend = (game.transcendCount > 0) || (game.stats.totalTranscend > 0) || (game.apotheosisCount > 0);
    const skinBtn = document.getElementById('skin-btn');
    if (skinBtn) {
        skinBtn.style.display = (game.apotheosisCount >= 10) ? 'flex' : 'none';
    }
    const hasPrestige = (game.prestigeCount > 0) || (game.stats.totalPrestige > 0);
    const hasApotheosis = (game.apotheosisCount > 0);

    document.getElementById('stat-row-relic').style.display = hasPrestige ? 'block' : 'none';
    document.getElementById('stat-row-prestige').style.display = hasPrestige ? 'block' : 'none';
    document.getElementById('stat-row-ether').style.display = hasTranscend ? 'block' : 'none';
    document.getElementById('stat-row-transcend').style.display = hasTranscend ? 'block' : 'none';
    document.getElementById('stat-row-apotheosis').style.display = hasApotheosis ? 'block' : 'none'; 

    const nextThreshold = getStageThreshold(game.currentStage + 1);
    const prevThreshold = getStageThreshold(game.currentStage);
    let progress = 0;
    if (nextThreshold > 0) progress = Math.min(100, Math.max(0, (game.totalScore - prevThreshold) / (nextThreshold - prevThreshold) * 100));
    else progress = 100;
    document.getElementById('stage-progress-fill').style.width = progress + "%";
    document.getElementById('stage-req-text').innerText = `Next Phase: ${formatNumber(nextThreshold)}`;
    document.getElementById('chal-total-bonus').innerText = `+${formatNumber((getGlobalChallengeMultiplier() - 1) * 100)}%`;

    const batchLvl = game.uniqueArtifacts.u_batch;
    document.getElementById('btn-buy-5').className = `buy-btn ${batchLvl >= 1 ? 'unlocked' : ''} ${buyMode===5?'active':''}`;
    document.getElementById('btn-buy-10').className = `buy-btn ${batchLvl >= 2 ? 'unlocked' : ''} ${buyMode===10?'active':''}`;
    document.getElementById('btn-buy-max').className = `buy-btn ${batchLvl >= 3 ? 'unlocked' : ''} ${buyMode===-1?'active':''}`;
    
    document.getElementById('btn-claim-all').style.display = game.uniqueArtifacts.u_claim_all > 0 ? 'block' : 'none';
    document.getElementById('btn-buy-all-max').style.display = batchLvl >= 4 ? 'block' : 'none';

    const headRelic = document.getElementById('header-relic-display');
    if (showArtifacts) {
        headRelic.style.display = 'block'; headRelic.innerText = "Relics : " + formatNumber(Math.floor(game.relics));
    } else {
        headRelic.style.display = 'none';
    }

    let previousUnlocked = true;
    const autoBuyLvl = game.uniqueArtifacts.u_auto_buy;
    const keys = Object.keys(MODULE_DATA);
    for(let i=0; i<keys.length; i++) {
        const k = keys[i];
        const bulk = getBulkModuleCost(k, buyMode);
        const modSpec = getModuleChallengeMultiplier(k);
        const basePwr = MODULE_DATA[k].power * globalMult * modSpec;
        const btn = document.getElementById(`btn-${k}`);
        if(!btn) continue;
        document.getElementById(`lv-${k}`).innerText = game.upgrades[k].count + (bulk.count > 0 ? ` (+${bulk.count})` : "");
        document.getElementById(`cost-${k}`).innerText = formatNumber(bulk.cost);
        document.getElementById(`eff-curr-${k}`).innerText = formatNumber(Math.floor(game.upgrades[k].count * basePwr));
        document.getElementById(`eff-next-${k}`).innerText = formatNumber(Math.floor((game.upgrades[k].count + bulk.count) * basePwr));

        if (previousUnlocked || game.seenModules[k]) {
            btn.style.display = 'flex';
            btn.style.opacity = (game.score >= bulk.cost && bulk.count > 0) ? "1" : "0.5";
            btn.style.borderColor = (game.score >= bulk.cost && bulk.count > 0) ? "var(--theme-color)" : "transparent";
            
            // è¡¨ç¤ºã•ã‚ŒãŸã‚‰ seenModules ã«è¨˜éŒ²
            if(!game.seenModules[k]) game.seenModules[k] = true;
            
            const abWrap = document.getElementById(`ab-wrap-${k}`);
            if (i < autoBuyLvl) {
                abWrap.style.display = 'flex';
                document.getElementById(`ab-toggle-${k}`).className = `toggle-switch ${game.autoBuyToggles[k] ? 'active' : ''}`;
            } else { abWrap.style.display = 'none'; }
        } else { 
            btn.style.display = 'none'; 
        }

        // æ¬¡ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ã‚¢ãƒ³ãƒ­ãƒƒã‚¯ã™ã‚‹æ¨©åˆ©ã¯ã€Œç¾åœ¨ã®æ‰€æŒæ•°ãŒ1ä»¥ä¸Šã€ã§ã‚ã‚‹ã“ã¨
        // (ã“ã‚Œã‚’ ORæ¡ä»¶ã«ã™ã‚‹ã¨ã€è¦‹ãŸã ã‘ã§å…¨ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒä¸€æ°—ã«é–‹æ”¾ã•ã‚Œã¦ã—ã¾ã†ãŸã‚ã€ã“ã“ã¯ANDæ¡ä»¶ã®ã¾ã¾ã«ã™ã‚‹)
        if (game.upgrades[k].count === 0) previousUnlocked = false;
    }

    document.getElementById('current-mult').innerText = "x" + globalMult.toFixed(2);
    document.getElementById('sys-chal-bonus').innerText = `+${formatNumber((getGlobalChallengeMultiplier() - 1) * 100)}%`;
    document.getElementById('relic-count').innerText = Math.floor(game.relics);
    document.getElementById('ether-count').innerText = Math.floor(game.ether);
    document.getElementById('sys-apotheosis').innerText = game.apotheosisCount; 
    document.getElementById('ether-display').innerText = Math.floor(game.ether);
    document.getElementById('sys-prestige').innerText = game.stats.totalPrestige;
    document.getElementById('sys-transcend').innerText = game.transcendCount;
    const clickStatEl = document.getElementById('stat-clicks');
    if(clickStatEl) clickStatEl.innerText = formatNumber(game.stats.totalClicks);

    const eTime = (Date.now() - game.startTime) / 1000;
    const hh = Math.floor(eTime / 3600).toString().padStart(2, '0');
    const mm = Math.floor((eTime % 3600) / 60).toString().padStart(2, '0');
    const ss = Math.floor(eTime % 60).toString().padStart(2, '0');
    document.getElementById('sys-time').innerText = `${hh}:${mm}:${ss}`;

    const relicGain = calculateRelicGain();
    const pBtn = document.getElementById('btn-prestige');
    const pGainText = document.getElementById('prestige-gain');
    if (game.totalScore >= PRESTIGE_THRESHOLD) {
        pBtn.disabled = false; pBtn.style.opacity = "1"; pGainText.innerText = `+${formatNumber(relicGain)} Relics`;
    } else {
        const unlockTxt = game.settings.lang === 'ja' ? 'è§£ç¦' : 'Unlock';
        pBtn.disabled = true; pBtn.style.opacity = "0.5"; pGainText.innerText = `${unlockTxt}: ${formatNumber(PRESTIGE_THRESHOLD)} Score`;
    }

    const tBtn = document.getElementById('btn-transcend');
    const etherGain = 1 * getApotheosisMult(); 
    document.getElementById('transcend-req').innerText = `REQ: ${formatNumber(tReq)} Relics`;
    if (game.relics >= tReq) { 
        tBtn.disabled = false; 
        document.getElementById('transcend-gain').innerText = `GAIN: +${formatNumber(etherGain)} Ether`; 
    } else { 
        tBtn.disabled = true; 
        document.getElementById('transcend-gain').innerText = `GAIN: +0 Ether`; 
    }

    document.getElementById('artifact-relic-display').innerText = Math.floor(game.relics);
    for(let k in ARTIFACT_DATA) {
        const bulk = getBulkArtifactCost(k, buyMode);
        document.getElementById(`art-lv-${k}`).innerText = game.artifacts[k] + (bulk.count > 0 ? ` (+${bulk.count})` : "");
        document.getElementById(`art-cost-${k}`).innerText = formatNumber(bulk.cost);
        document.getElementById(`art-eff-curr-${k}`).innerText = getArtifactEffectString(k, game.artifacts[k]);
        document.getElementById(`art-eff-next-${k}`).innerText = getArtifactEffectString(k, game.artifacts[k] + bulk.count);
        const div = document.getElementById(`art-btn-${k}`);
        div.style.opacity = (game.relics >= bulk.cost && bulk.count > 0) ? "1" : "0.5";
        div.style.borderColor = (game.relics >= bulk.cost && bulk.count > 0) ? "var(--rare)" : "#333";
    }

    for(let k in UNIQUE_DATA) {
        const level = game.uniqueArtifacts[k];
        const cost = getUniqueArtifactCost(k);
        const div = document.getElementById(`unique-btn-${k}`);
        document.getElementById(`u-lv-${k}`).innerText = level;
        if (level >= UNIQUE_DATA[k].max) { div.classList.add('purchased'); document.getElementById(`u-cost-${k}`).innerText = "---"; }
        else {
            div.classList.remove('purchased'); document.getElementById(`u-cost-${k}`).innerText = formatNumber(cost);
            div.style.opacity = (game.relics >= cost) ? "1" : "0.5";
            div.style.borderColor = (game.relics >= cost) ? "var(--unique)" : "#333";
        }
    }

    for(let k in ADVANCED_DATA) {
        // å¤‰æ›´: bulkè¨ˆç®—ã‚’ä½¿ç”¨
        const bulk = getBulkAdvancedArtifactCost(k, buyMode);
        const def = ADVANCED_DATA[k];
        const currentLevel = game.advancedArtifacts[k] || 0;
        
        // ãƒ¬ãƒ™ãƒ«è¡¨ç¤º: (+n) ã®å¢—åŠ åˆ†ã‚’è¡¨ç¤ºã«è¿½åŠ 
        document.getElementById(`adv-lv-${k}`).innerText = 
            (def.max ? `${currentLevel}/${def.max}` : currentLevel) + 
            (bulk.count > 0 ? ` (+${bulk.count})` : "");
            
        const div = document.getElementById(`adv-btn-${k}`);
        
        if (def.max && currentLevel >= def.max) {
            document.getElementById(`adv-cost-${k}`).innerText = "ACQUIRED";
            div.classList.add('purchased');
            div.style.opacity = "0.5";
            div.style.borderColor = "#333";
        } else {
            // ã‚³ã‚¹ãƒˆè¡¨ç¤ºã‚’æ›´æ–°
            document.getElementById(`adv-cost-${k}`).innerText = formatNumber(bulk.cost);
            div.classList.remove('purchased');
            
            // è³¼å…¥å¯å¦åˆ¤å®š: ã‚³ã‚¹ãƒˆãŒæ‰•ãˆã¦ã€ã‹ã¤è³¼å…¥æ•°(count)ãŒ1ä»¥ä¸Šã‚ã‚‹ã‹
            const canBuy = (game.ether >= bulk.cost && bulk.count > 0);
            
            div.style.opacity = canBuy ? "1" : "0.5";
            div.style.borderColor = canBuy ? "var(--ether)" : "#333";
        }
    }
    updateChallengesUI();
}

function updateChallengesUI() {
    checkMaxStats(); 
    const list = document.getElementById('challenge-list');
    const lang = game.settings.lang || 'ja';
    const L = LANG_DATA[lang];
    const CATEGORY_NAMES = { 
        'stat': L.catStat, 
        'module': L.catModule, 
        'unique': L.catUnique, 
        'artifact': L.catArtifact, 
        'advanced': L.catAdvanced
    };
    const CATEGORY_ORDER = ['stat', 'module', 'unique', 'artifact', 'advanced'];

    CATEGORY_ORDER.forEach(cat => {
        let header = document.getElementById(`cat-header-${cat}`);
        if (!header) {
            header = document.createElement('div');
            header.id = `cat-header-${cat}`;
            header.className = 'challenge-header';
            list.appendChild(header);
        }
        header.innerText = CATEGORY_NAMES[cat];
        header.style.display = 'none';
    });

    const sortedKeys = Object.keys(CHALLENGE_DEFS).sort((a, b) => {
        return (CHALLENGE_DEFS[a].order || 999) - (CHALLENGE_DEFS[b].order || 999);
    });

    const hasPrestige = (game.prestigeCount > 0 || game.stats.totalPrestige > 0);
    const hasTranscend = (game.transcendCount > 0) || (game.stats.totalTranscend > 0) || (game.apotheosisCount > 0);
    const hasArtifacts = hasPrestige || hasTranscend;

    sortedKeys.forEach(k => {
        const def = CHALLENGE_DEFS[k];
        if (def.isModule && !game.seenModules[def.key]) return;
        if ((def.category === 'artifact' || def.category === 'unique') && !hasArtifacts) return;
        if (def.category === 'advanced' && !hasTranscend) return;

        if (def.key === 'relics' || def.key === 'prestigeCount') { if (!hasArtifacts) return; }
        if (def.key === 'transcendCount') { if (!hasTranscend) return; }
        if (def.key === 'apotheosisCount') { if (game.apotheosisCount <= 0) return; }

        const header = document.getElementById(`cat-header-${def.category}`);
        if(header) header.style.display = 'block';

        const elId = `chal-card-${k}`;
        let card = document.getElementById(elId);
        if (!card) {
            card = document.createElement('div');
            card.id = elId;
            card.className = 'challenge-card';
            card.innerHTML = `
                <div class="btn-row">
                    <span class="c-desc" style="font-size:0.85rem; font-weight:bold;"></span>
                    <span class="c-progress" style="font-size:0.8rem; color:var(--theme-color);"></span>
                </div>
                <div class="btn-row" style="margin-top:5px;">
                    <span class="c-reward" style="font-size:0.75rem; color:#aaa;"></span>
                </div>
                <div class="c-btn-area" style="margin-top:5px; width:100%;"></div>`;
            list.appendChild(card);
        }
        
        const tier = game.challengeTiers[k] || 1;
        let target;
        if (def.mode === 'step') target = def.baseTarget * tier;
        else if (def.mode === 'linear') target = def.baseTarget + (tier - 1);
        else if (def.isPhase) target = def.baseTarget + (tier - 1);
        else target = Math.floor(def.baseTarget * Math.pow(def.scale, tier - 1));
        
        let maxLvl = Infinity;
        if(def.isArtifact && ARTIFACT_DATA[def.key] && ARTIFACT_DATA[def.key].max) maxLvl = ARTIFACT_DATA[def.key].max;
        if(def.isUnique && UNIQUE_DATA[def.key] && UNIQUE_DATA[def.key].max) maxLvl = UNIQUE_DATA[def.key].max;
        if(def.isAdvanced && ADVANCED_DATA[def.key] && ADVANCED_DATA[def.key].max) maxLvl = ADVANCED_DATA[def.key].max;
        
        let current = 0;
        if(def.key === 'relics') current = game.stats.maxRelics;
        else if(def.isModule) current = game.stats.maxModules[def.key] || 0;
        else if(def.isArtifact) current = game.stats.maxArtifacts[def.key] || 0;
        else if(def.isUnique) current = (game.stats.maxUnique && game.stats.maxUnique[def.key]) || 0;
        else if(def.isAdvanced) current = (game.stats.maxAdvanced && game.stats.maxAdvanced[def.key]) || 0;
        else if(def.key in game.stats) current = game.stats[def.key];
        else if(def.key === 'prestigeCount') current = game.stats.totalPrestige;
        else if(def.key === 'transcendCount') current = game.stats.totalTranscend || 0;
        else if(def.key === 'apotheosisCount') current = game.apotheosisCount;
        else if(def.key === 'currentStage') current = game.stats.maxStage + 1;

        let isCompleted = (target > maxLvl);
        let rewardText = "";
        const descText = lang === 'ja' ? def.desc_ja : def.desc_en;

        if (def.category === 'module') {
            const mName = lang === 'ja' ? MODULE_DATA[def.key].name_ja : MODULE_DATA[def.key].name_en;
            rewardText = `${L.passiveModule.replace('ç”Ÿç”£', mName + ' ç”Ÿç”£')}`;
        } else {
            rewardText = `${L.passiveGlobal} +${(def.rewardBase*100).toFixed(0)}%`;
        }

        card.querySelector('.c-desc').innerText = `${descText} Tier${tier}`;
        const progressEl = card.querySelector('.c-progress');
        const btnArea = card.querySelector('.c-btn-area');

        if (isCompleted) {
            card.classList.add('completed');
            card.classList.remove('claimable');
            progressEl.innerText = "COMPLETED";
            progressEl.style.color = "var(--unique)";
            btnArea.innerHTML = '';
        } else {
            card.classList.remove('completed');
            progressEl.innerText = `${formatNumber(current)} / ${formatNumber(target)}`;
            progressEl.style.color = "var(--theme-color)";
            
            if (current >= target) {
                card.classList.add('claimable');
                if (!btnArea.querySelector('.claim-btn')) {
                    btnArea.innerHTML = '';
                    const btn = document.createElement('button');
                    btn.className = 'claim-btn';
                    btn.innerText = L.btnClaim; 
                    btn.onclick = (e) => { e.stopPropagation(); claimChallenge(k); };
                    btnArea.appendChild(btn);
                }
            } else {
                card.classList.remove('claimable');
                btnArea.innerHTML = '';
            }
        }
        card.querySelector('.c-reward').innerText = `${lang === 'ja' ? 'å ±é…¬' : 'Reward'}: ${rewardText}`;
    });

    const desiredOrder = [];
    CATEGORY_ORDER.forEach(cat => {
        const header = document.getElementById(`cat-header-${cat}`);
        if(header) desiredOrder.push(header);
        const catKeys = sortedKeys.filter(k => {
            const def = CHALLENGE_DEFS[k];
            if (def.isModule && !game.seenModules[def.key]) return false;
            if ((def.category === 'artifact' || def.category === 'unique') && !hasArtifacts) return false;
            if (def.category === 'advanced' && !hasTranscend) return false;
            if (def.key === 'relics' || def.key === 'prestigeCount') { if (!hasArtifacts) return false; }
            if (def.key === 'transcendCount') { if (!hasTranscend) return false; }
            if (def.key === 'apotheosisCount') { if (game.apotheosisCount <= 0) return false; }
            return def.category === cat;
        });
        catKeys.forEach(k => {
             const c = document.getElementById(`chal-card-${k}`);
             if(c) desiredOrder.push(c);
        });
    });

    const children = Array.from(list.children);
    let dirty = (children.length !== desiredOrder.length);
    if(!dirty) {
        for(let i=0; i<children.length; i++) if(children[i] !== desiredOrder[i]) { dirty = true; break; }
    }
    if(dirty) desiredOrder.forEach(el => list.appendChild(el));
}

function claimChallenge(key, silent = false) {
    let updated = false;
    const def = CHALLENGE_DEFS[key];
    let safetyCounter = 0;
    while(safetyCounter < 1000) {
        safetyCounter++;
        let tier = game.challengeTiers[key] || 1;
        let target;
        if (def.mode === 'step') target = def.baseTarget * tier;
        else if (def.mode === 'linear') target = def.baseTarget + (tier - 1);
        else if (def.isPhase) target = def.baseTarget + (tier - 1);
        else target = Math.floor(def.baseTarget * Math.pow(def.scale, tier - 1));
        
        let maxLvl = Infinity;
        if(def.isArtifact && ARTIFACT_DATA[def.key] && ARTIFACT_DATA[def.key].max) maxLvl = ARTIFACT_DATA[def.key].max;
        if(def.isUnique && UNIQUE_DATA[def.key] && UNIQUE_DATA[def.key].max) maxLvl = UNIQUE_DATA[def.key].max;
        if(def.isAdvanced && ADVANCED_DATA[def.key] && ADVANCED_DATA[def.key].max) maxLvl = ADVANCED_DATA[def.key].max;
        if(target > maxLvl) break;

        let current = 0;
        if(def.key === 'relics') current = game.stats.maxRelics;
        else if(def.isModule) current = game.stats.maxModules[def.key] || 0;
        else if(def.isArtifact) current = game.stats.maxArtifacts[def.key] || 0;
        else if(def.isUnique) current = game.stats.maxUnique[def.key] || 0;
        else if(def.isAdvanced) current = game.stats.maxAdvanced[def.key] || 0;
        else if(def.key in game.stats) current = game.stats[def.key];
        else if(def.key === 'prestigeCount') current = game.stats.totalPrestige;
        else if(def.key === 'transcendCount') current = game.stats.totalTranscend || 0;
        else if(def.key === 'apotheosisCount') current = game.apotheosisCount;
        else if(def.key === 'currentStage') current = game.stats.maxStage + 1;
        
        if (current >= target) {
            game.challengeTiers[key] = tier + 1;
            updated = true;
            if(!silent) break;
        } else break;
    }
    if(updated && !silent) updateUI();
    return updated;
}

function claimAllChallenges() {
    let anyUpdated = false;
    for(let k in CHALLENGE_DEFS) if(claimChallenge(k, true)) anyUpdated = true;
    if (anyUpdated) {
        spawnFloater(window.innerWidth/2, window.innerHeight/2, `CLAIMED ALL REWARDS!`, true);
        updateUI();
    }
}

function hasAutoModule() {
    for(let k in MODULE_DATA) if(MODULE_DATA[k].type === 'auto' && game.upgrades[k].count > 0) return true;
    return false;
}

function updateStageConfig(init = false) {
    const config = getStageConfig(game.currentStage);
    document.documentElement.style.setProperty('--theme-color', config.color);
    document.documentElement.style.setProperty('--theme-dim', config.dim);
    document.getElementById('stage-badge').innerText = config.displayName;
    
    // èƒŒæ™¯ã‚°ãƒ­ãƒ¼ã®èª¿æ•´
    const glowLayer = document.getElementById('bg-glow');
    if (glowLayer) {
        if (hasAutoModule() && game.settings.bgColor) glowLayer.style.opacity = '0.2'; 
        else glowLayer.style.opacity = '0';
    }

    const reactor = document.getElementById('reactor-wrapper');
    CYCLE_SHAPE_CLASSES.forEach(cls => reactor.classList.remove(cls));
    reactor.classList.add(config.shapeClass);

    /* --- å›è»¢é€Ÿåº¦ã®å‹•çš„åˆ¶å¾¡ã“ã“ã‹ã‚‰ --- */
    // ã‚¹ãƒ†ãƒ¼ã‚¸å†…ã§ã®é€²æ— (0ã€œ4ãƒ•ã‚§ãƒ¼ã‚º) ã‚’å–å¾—
    const phaseInStage = game.currentStage % STAGE_DEFS.length;
    // ãƒ™ãƒ¼ã‚¹é€Ÿåº¦ 1.0 ã«ã€ãƒ•ã‚§ãƒ¼ã‚ºãŒé€²ã‚€ã”ã¨ã« 0.2 ãšã¤åŠ ç®— (ä¾‹: 1.0, 1.2, 1.4, 1.6, 1.8)
    const speedMultiplier = 1.0 + (phaseInStage * 0.2);
    
    // å…¨ã¦ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é€Ÿåº¦ã‚’æ›´æ–°
    const layers = reactor.querySelectorAll('.r-layer');
    layers.forEach(layer => {
        // layer.getAnimations() ã§å‹•ä½œä¸­ã®CSSã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å–å¾—ã—ã¦é€Ÿåº¦ã‚’å¤‰æ›´
        layer.getAnimations().forEach(anim => {
            anim.updatePlaybackRate(speedMultiplier);
        });
    });
    /* --- å›è»¢é€Ÿåº¦ã®å‹•çš„åˆ¶å¾¡ã“ã“ã¾ã§ --- */

    if(!init) spawnFloater(window.innerWidth/2, window.innerHeight/2 - 100, "PHASE SHIFT!", true);
}

function switchTab(tabName, btn) {
    // 1. ç¾åœ¨è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã‚¿ãƒ–ã‚’æ¢ã—ã€ãã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’ä¿å­˜ã™ã‚‹
    document.querySelectorAll('.tab-content').forEach(c => {
        if(c.style.display === 'block') {
            tabScrollStates[c.id] = c.scrollTop;
        }
        c.style.display = 'none'; // ã¤ã„ã§ã«éè¡¨ç¤ºã«ã™ã‚‹
    });

    // 2. æ–°ã—ã„ã‚¿ãƒ–ã‚’è¡¨ç¤º
    const target = document.getElementById(`tab-${tabName}`);
    if(target) {
        target.style.display = 'block';
        
        // 3. è¨˜æ†¶ã—ã¦ã„ãŸä½ç½®ãŒã‚ã‚Œã°å¾©å…ƒã™ã‚‹
        if(tabScrollStates[target.id] !== undefined) {
            target.scrollTop = tabScrollStates[target.id];
        }
    }

    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
}
function buyUpgrade(k) {
    const bulk = getBulkModuleCost(k, buyMode);
    if (bulk.count > 0 && game.score >= bulk.cost) {
        game.score -= bulk.cost;
        game.upgrades[k].count += bulk.count;
        updateStageConfig(true); // ãƒ•ã‚§ãƒ¼ã‚ºæ›´æ–°ãƒã‚§ãƒƒã‚¯
        updateUI();
    }
}
function buyAllModulesMax() {
    const keys = Object.keys(MODULE_DATA).reverse();
    let boughtAny = false;
    for(let k of keys) {
        const bulk = getBulkModuleCost(k, -1);
        if(bulk.count > 0 && game.score >= bulk.cost) {
            game.score -= bulk.cost; game.upgrades[k].count += bulk.count; boughtAny = true;
        }
    }
    if(boughtAny) { updateStageConfig(true); updateUI(); }
}

function buyArtifact(k) {
    const bulk = getBulkArtifactCost(k, buyMode);
    if(bulk.count > 0 && game.relics >= bulk.cost) {
        game.relics -= bulk.cost; game.artifacts[k] += bulk.count; updateUI(); 
    }
}

function buyUniqueArtifact(k) {
    const cost = getUniqueArtifactCost(k);
    if (game.uniqueArtifacts[k] < UNIQUE_DATA[k].max && game.relics >= cost) {
        game.relics -= cost; game.uniqueArtifacts[k]++; updateUI();
    }
}

function buyAdvancedArtifact(k) {
    // å¤‰æ›´: bulkè¨ˆç®—é–¢æ•°ã‚’ä½¿ç”¨
    const bulk = getBulkAdvancedArtifactCost(k, buyMode);
    
    if (bulk.count > 0 && game.ether >= bulk.cost) { 
        game.ether -= bulk.cost; 
        game.advancedArtifacts[k] += bulk.count; // ã¾ã¨ã‚ã¦åŠ ç®—
        
        // æ°¸ç¶šåŒ–ãƒœãƒ¼ãƒŠã‚¹ã®å³æ™‚é©ç”¨ãƒã‚§ãƒƒã‚¯
        if(k === 'adv_perm_batch' && game.advancedArtifacts[k] > 0) game.uniqueArtifacts.u_batch = 4;
        if(k === 'adv_perm_admin' && game.advancedArtifacts[k] > 0) game.uniqueArtifacts.u_claim_all = 1;
        if(k === 'adv_perm_auto' && game.advancedArtifacts[k] > 0) game.uniqueArtifacts.u_auto_buy = Object.keys(MODULE_DATA).length;
        
        updateUI(); 
    }
}

function tryPrestige() {
    const gain = calculateRelicGain();
    if(gain <= 0) return;
    const confirmMsg = game.settings.lang === 'ja' ? `æ¬¡å…ƒè»¢ç”Ÿã‚’å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ\n\nç²å¾—ãƒ¬ãƒªãƒƒã‚¯: ${gain}` : `Perform Dimension Reset?\n\nGain Relics: ${gain}`;
    if(!game.settings.confirmations || confirm(confirmMsg)) {
        game.relics += gain; 
        game.prestigeCount++; 
        game.stats.totalPrestige++;
        resetTier1();
    }
}

function tryTranscend() {
    const req = getTranscendReq();
    if(game.relics < req) return;
    
    // ã€å¤‰æ›´ã€‘å€ç‡ã‚’ã‹ã‘ãšã€å›ºå®šå€¤ 1 ã‚’ç²å¾—ã™ã‚‹ã‚ˆã†ã«æˆ»ã™
    const gain = 1; 
    
    // ... (ä»¥ä¸‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸éƒ¨åˆ†ã¯å¾Œè¿°ã®ã‚¹ãƒ†ãƒƒãƒ—4ã«ã¯å«ã¾ã‚Œã¾ã›ã‚“ãŒã€æ©Ÿèƒ½ã¨ã—ã¦ã¯ã“ã‚Œã§OK) ...
    const confirmMsg = game.settings.lang === 'ja' ? `ã€è­¦å‘Šã€‘è¶…è¶Šã‚’å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ\n\nç²å¾—ã‚¨ãƒ¼ãƒ†ãƒ«: +${gain}\n\nã“ã‚Œã¾ã§ã®å…¨ã¦ã®é€²è¡Œåº¦ã€ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã€é€šå¸¸/ãƒ¦ãƒ‹ãƒ¼ã‚¯ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆãŒãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™ã€‚\n(è¶…è¶Šã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã¯ç¶­æŒã•ã‚Œã¾ã™)` : `[WARNING] Perform Transcendence?\n\nGain Ether: +${gain}\n\nAll progress, modules, and artifacts will be reset. (Advanced Artifacts will remain)`;
    if(!game.settings.confirmations || confirm(confirmMsg)) {
        game.ether += gain; 
        game.transcendCount++; 
        game.stats.totalTranscend++; 
        resetTier2();
    }
}

function tryApotheosis() {
    const req = getApotheosisReq();
    if(game.currentStage + 1 < req) return;
    
    const nextCount = game.apotheosisCount + 1;
    const nextOther = nextCount * 10;
    
    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‹ã‚‰ã€Œã‚¹ã‚³ã‚¢ã€ã®è¨˜è¿°ã‚’å‰Šé™¤
    const confirmMsg = game.settings.lang === 'ja' 
        ? `ã€çœŸåŒ– - APOTHEOSISã€‘\n\nã“ã®æ“ä½œã¯ã€ã‚¨ãƒ¼ãƒ†ãƒ«ã€è¶…è¶Šã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã€è¶…è¶Šå›æ•°ã‚’å«ã‚€å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã€‚\n\nå®Ÿè¡Œã™ã‚‹ã¨ä»¥ä¸‹ã®æ°¸ç¶šãƒœãƒ¼ãƒŠã‚¹ã‚’ç²å¾—ã—ã¾ã™ï¼š\næ¬¡å›ã‹ã‚‰åˆæœŸæ‰€æŒæ•°ãƒœãƒ¼ãƒŠã‚¹\nã‚¨ãƒ¼ãƒ†ãƒ« +${nextOther}\n\nå®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ` 
        : `[APOTHEOSIS]\n\nThis will reset EVERYTHING including Ether.\n\nNew Bonus:\nStart with:\n+${nextOther} Ether\n\nProceed?`;
        
    if(!game.settings.confirmations || confirm(confirmMsg)) {
        game.apotheosisCount++;
        resetTier3();
    }
}

function resetTier1() {
    checkMaxStats();
    // ã€å¤‰æ›´ã€‘ã‚¹ã‚³ã‚¢ã«ã¯ ScoreBonus (100å€) ã‚’ä½¿ç”¨
    const scoreBonus = getApotheosisScoreBonus();
    game.score = scoreBonus; 
    game.totalScore = scoreBonus;
    
    game.currentStage = 0;
    particles = []; 
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    for(let k in MODULE_DATA) { if(!game.upgrades[k]) game.upgrades[k] = {}; game.upgrades[k].count = 0; }
    if(game.advancedArtifacts.adv_perm_batch) game.uniqueArtifacts.u_batch = 4;
    if(game.advancedArtifacts.adv_perm_admin) game.uniqueArtifacts.u_claim_all = 1;
    if(game.advancedArtifacts.adv_perm_auto) game.uniqueArtifacts.u_auto_buy = Object.keys(MODULE_DATA).length;
    const glowLayer = document.getElementById('bg-glow');
    if(glowLayer) { glowLayer.style.opacity = '0'; void glowLayer.offsetWidth; }
    updateStageConfig(); 
    saveGame();
}

function resetTier2() {
    saveScrollPositions();
    checkMaxStats(); 
    const scoreBonus = getApotheosisScoreBonus();
    const otherBonus = getApotheosisStartBonus();
    
    game.score = scoreBonus; 
    game.totalScore = scoreBonus; 
    game.relics = 0;
    
    game.prestigeCount = 0; game.currentStage = 0;
    particles = []; ctx.clearRect(0, 0, canvas.width, canvas.height);
    for(let k in MODULE_DATA) if(game.upgrades[k]) game.upgrades[k].count = 0;
    for(let k in ARTIFACT_DATA) game.artifacts[k] = 0;
    for(let k in UNIQUE_DATA) game.uniqueArtifacts[k] = 0;
    if(game.advancedArtifacts.adv_perm_batch) game.uniqueArtifacts.u_batch = 4;
    if(game.advancedArtifacts.adv_perm_admin) game.uniqueArtifacts.u_claim_all = 1;
    if(game.advancedArtifacts.adv_perm_auto) game.uniqueArtifacts.u_auto_buy = Object.keys(MODULE_DATA).length;
    updateStageConfig(); 
    saveGame(); 
    location.reload();
}

function resetTier3() {
    saveScrollPositions();
    checkMaxStats();
    const scoreBonus = getApotheosisScoreBonus();
    const otherBonus = getApotheosisStartBonus();
    
    game.score = scoreBonus; 
    game.totalScore = scoreBonus; 
    game.relics = 0; 
    game.ether = otherBonus;
    
    game.prestigeCount = 0;
    game.transcendCount = 0;
    game.currentStage = 0;
    particles = []; ctx.clearRect(0, 0, canvas.width, canvas.height);
    for(let k in game.upgrades) game.upgrades[k].count = 0;
    for(let k in game.artifacts) game.artifacts[k] = 0;
    for(let k in game.uniqueArtifacts) game.uniqueArtifacts[k] = 0;
    for(let k in game.advancedArtifacts) game.advancedArtifacts[k] = 0; 
    updateStageConfig(); 
    spawnFloater(window.innerWidth/2, window.innerHeight/2, "APOTHEOSIS COMPLETE", true);
    game.settings.buyMode = 1;
    saveGame(); 
    location.reload();
}

function gameLoop() {
    let now = Date.now(); let dt = (now - lastTime) / 1000; lastTime = now;
    let effectiveDt = dt * getTimeSpeed();
    let inc = getAutoIncome(); if(inc > 0) addScore(inc * effectiveDt);
    const acLevel = getArtifactEffectValue('art_auto_click', game.artifacts.art_auto_click);
    if (acLevel > 0) {
        autoClickAccumulator += effectiveDt * acLevel;
        if (autoClickAccumulator >= 1) {
            const clicks = Math.floor(autoClickAccumulator);
            autoClickAccumulator -= clicks;
            const critChance = getArtifactEffectValue('art_crit', game.artifacts.art_crit);
            const critMult = getArtifactEffectValue('art_crit_dmg', game.artifacts.art_crit_dmg);
            const basePwr = getClickPower();
            let totalDmg = 0;
            const rect = document.getElementById('reactor-wrapper').getBoundingClientRect();
            const cx = rect.left + rect.width / 2;
            const cy = rect.top + rect.height / 2;
            for(let i=0; i<clicks; i++) {
                let dmg = basePwr; let isCrit = false;
                if(Math.random() < critChance) { dmg *= critMult; isCrit = true; }
                totalDmg += dmg;
                if (i < 3 && game.settings.numbers) {
                    spawnFloater(cx + (Math.random()-0.5)*100, cy + (Math.random()-0.5)*100, `+${formatNumber(dmg)}`, isCrit);
                }
            }
            addScore(totalDmg); game.stats.totalClicks += clicks;
        }
    }
    const autoBuyLevel = game.uniqueArtifacts.u_auto_buy;
    const keys = Object.keys(MODULE_DATA);
    for(let i=0; i<Math.min(keys.length, autoBuyLevel); i++) {
        const k = keys[i];
        if (game.autoBuyToggles[k]) {
            const bulk = getBulkModuleCost(k, 1);
            if (bulk.count > 0 && game.score >= bulk.cost) {
                game.score -= bulk.cost; game.upgrades[k].count += bulk.count;
            }
        }
    }
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.globalCompositeOperation = 'lighter'; 
    for(let i=particles.length-1; i>=0; i--) {
        particles[i].update(); particles[i].draw(ctx); if(particles[i].life<=0) particles.splice(i,1);
    }
    if(inc > 0 && Math.random() < 0.1) {
        let rect = document.getElementById('reactor-wrapper').getBoundingClientRect();
        spawnParticles(rect.left+rect.width/2, rect.top+rect.height/2, 1, 'idle');
    }
    requestAnimationFrame(gameLoop);
}

class Particle {
    constructor(x, y, type) {
        this.x = x; this.y = y; this.type = type;
        const config = getStageConfig(game.currentStage);
        const angle = Math.random() * 6.28; let speed = Math.random() * 3 + 1;
        this.size = Math.random() * 3 + 2; this.life = 1.0; this.decay = Math.random() * 0.03 + 0.01;
        this.color = config.color; 
        const shapes = ['circle', 'triangle', 'square', 'pentagon', 'hexagon', 'octagon', 'rhombus', 'pentagram', 'hexagram', 'legendary'];
        let shapeIndex = (game.currentStage) % shapes.length;
        this.shape = shapes[shapeIndex];
        if(type === 'crit') { this.color = '#fff'; speed *= 2; this.size = 6; this.shape = 'legendary'; }
        else if(type === 'relic') { this.color = '#b042ff'; this.decay = 0.01; this.shape = 'rhombus'; }
        else if(type === 'stageup') { this.color = '#ffffff'; speed *= 4; this.life = 1.5; }
        this.vx = Math.cos(angle) * speed; this.vy = Math.sin(angle) * speed;
    }
    update() { this.x += this.vx; this.y += this.vy; this.life -= this.decay; this.size *= 0.96; }
    draw(ctx) {
        ctx.globalAlpha = this.life; ctx.fillStyle = this.color; ctx.strokeStyle = this.color; ctx.lineWidth = 2; ctx.beginPath();
        drawComplexShape(ctx, this.x, this.y, this.size, this.shape);
        ctx.fill();
        if (['square', 'triangle', 'rhombus', 'pentagon', 'hexagon', 'octagon'].includes(this.shape)) ctx.stroke();
        if(game.settings.bloom) { ctx.shadowBlur = 10; ctx.shadowColor = this.color; }
        else ctx.shadowBlur = 0;
    }
}

function drawComplexShape(ctx, x, y, r, type) {
    switch(type) {
        case 'circle': ctx.arc(x, y, r, 0, 6.28); break;
        case 'triangle': drawPoly(ctx, x, y, r, 3); break;
        case 'square': ctx.rect(x-r, y-r, r*2, r*2); break;
        case 'pentagon': drawPoly(ctx, x, y, r, 5); break;
        case 'hexagon': drawPoly(ctx, x, y, r, 6); break;
        case 'octagon': drawPoly(ctx, x, y, r, 8); break;
        case 'rhombus': ctx.moveTo(x, y-r*1.5); ctx.lineTo(x+r, y); ctx.lineTo(x, y+r*1.5); ctx.lineTo(x-r, y); break;
        case 'pentagram': drawStar(ctx, x, y, r, 5, 0.5); break;
        case 'hexagram': drawStar(ctx, x, y, r, 6, 0.6); break;
        case 'legendary': drawStar(ctx, x, y, r, 12, 0.4); break;
        default: ctx.arc(x, y, r, 0, 6.28);
    }
}

function drawPoly(ctx, x, y, r, sides) {
    ctx.moveTo(x + r * Math.cos(0), y + r * Math.sin(0));
    for (let i = 1; i <= sides; i++) ctx.lineTo(x + r * Math.cos(i * 2 * Math.PI / sides), y + r * Math.sin(i * 2 * Math.PI / sides));
}

function drawStar(ctx, x, y, r, p, ins) {
    ctx.moveTo(x, y - r);
    for (let i = 0; i < p * 2; i++) {
        const rad = (i % 2 === 0) ? r : r * ins;
        const a = (Math.PI / p) * i - Math.PI / 2;
        ctx.lineTo(x + rad * Math.cos(a), y + rad * Math.sin(a));
    }
}

function spawnParticles(x, y, count, type) {
    let limit = 300;
    if (game.settings.particles === 'med') { count = Math.ceil(count * 0.5); limit = 150; }
    if (game.settings.particles === 'low') { count = Math.ceil(count * 0.2); limit = 60; }
    if(particles.length > limit) particles.splice(0, count);
    for(let i=0; i<count; i++) particles.push(new Particle(x, y, type));
}

function spawnFloater(x, y, txt, isCrit) {
    const d = document.createElement('div'); d.className = 'floater'; d.innerText = txt;
    d.style.left = x + 'px'; d.style.top = y + 'px';
    if(isCrit) { d.style.color = '#ff0055'; d.style.fontSize = '1.5rem'; }
    document.body.appendChild(d); setTimeout(()=>d.remove(), 800);
}
function resizeCanvas() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
function formatNumber(num) {
    if (isNaN(num) || num === 0) return "0";
    
    // 100,000æœªæº€ï¼ˆE+5æœªæº€ï¼‰ã¯é€šå¸¸ã®ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šè¡¨è¨˜
    if (num < 100000) {
        return Math.floor(num).toLocaleString();
    }

    // 100,000ä»¥ä¸Šï¼ˆE+5ä»¥ä¸Šï¼‰ã¯å·¥å­¦è¡¨è¨˜ã«åˆ‡ã‚Šæ›¿ãˆ
    const exponent = Math.floor(Math.log10(num));
    const engExponent = Math.floor(exponent / 3) * 3;
    const mantissa = num / Math.pow(10, engExponent);

    // è¦‹æ „ãˆã‚’æ•´ãˆã‚‹ãŸã‚ã€ä»®æ•°éƒ¨ã¯å°æ•°ç‚¹ç¬¬2ä½ã¾ã§è¡¨ç¤º
    return mantissa.toFixed(2) + " E+" + engExponent;
}
function saveGame() { 
    game.lastSaveTime = Date.now(); 
    localStorage.setItem('neoEvoSaveV16', JSON.stringify(game)); 
}
function manualSave() { 
    saveGame(); 
    const btn = document.getElementById('btn-manual-save');
    const originalText = btn.innerHTML;
    btn.innerHTML = game.settings.lang === 'ja' ? "âœ… ä¿å­˜å®Œäº†ï¼" : "âœ… SAVE COMPLETE!";
    btn.style.borderColor = "#00ff00"; btn.style.color = "#00ff00";
    spawnFloater(window.innerWidth / 2, window.innerHeight / 2, "DATA SAVED!", true);
    setTimeout(() => {
        btn.innerHTML = originalText;
        btn.style.borderColor = "var(--unique)"; btn.style.color = "var(--unique)";
    }, 1500);
}

function fixGameData(data) {
    if(!game.skinSettings) game.skinSettings = { mode: 'auto', manualColor: 'auto', manualShape: 'auto' };
    game = { ...game, ...data };
    
    // åŸºæœ¬è¨­å®šã®ä¿®å¾©
    if(!game.upgrades) game.upgrades = {};
    if(!game.settings) game.settings = { particles: 'high', bloom: true, blur: true, numbers: true, bgColor: true, lang: 'ja' };
    if(game.settings.bgColor === undefined) game.settings.bgColor = true;
    if(game.settings.lang === undefined) game.settings.lang = 'ja';
    if(game.settings.buyMode === undefined) game.settings.buyMode = 1;
    if(game.settings.confirmations === undefined) game.settings.confirmations = true;
    if(game.apotheosisCount === undefined) game.apotheosisCount = 0;
    
    // çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã®ä¿®å¾© (ã“ã“ãŒé‡è¦)
    if(!game.stats) game.stats = {};
    const s = game.stats;
    if(s.totalClicks === undefined) s.totalClicks = 0;
    if(s.maxStage === undefined) s.maxStage = 0;
    if(s.maxRelics === undefined) s.maxRelics = 0;
    if(s.totalPrestige === undefined) s.totalPrestige = 0;
    if(s.totalTranscend === undefined) s.totalTranscend = game.transcendCount || 0;
    
    // å„ç¨®MAXçµ±è¨ˆã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ä½œæˆ
    if(!s.maxModules) s.maxModules = {};
    if(!s.maxArtifacts) s.maxArtifacts = {};
    if(!s.maxUnique) s.maxUnique = {};
    if(!s.maxAdvanced) s.maxAdvanced = {};

    // ãƒ‡ãƒ¼ã‚¿ã®æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯
    if(!game.advancedArtifacts) game.advancedArtifacts = {}; // ã“ã‚ŒãŒãªã„ã¨ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹
    
    for(let k in MODULE_DATA) { 
        if(!game.upgrades[k]) game.upgrades[k] = {count:0}; 
        if(game.autoBuyToggles[k]===undefined) game.autoBuyToggles[k]=false; 
    }
    for(let k in ARTIFACT_DATA) if(!game.artifacts[k]) game.artifacts[k] = 0;
    for(let k in UNIQUE_DATA) if(!game.uniqueArtifacts[k]) game.uniqueArtifacts[k] = 0;
    for(let k in ADVANCED_DATA) if(game.advancedArtifacts[k] === undefined) game.advancedArtifacts[k] = 0;
    
    if(!game.challengeTiers) game.challengeTiers = {};
    for(let k in CHALLENGE_DEFS) if(!game.challengeTiers[k]) game.challengeTiers[k] = 1;
    
    if(!game.seenModules) game.seenModules = {};
    for(let k in MODULE_DATA) {
        // ã‚‚ã—éå»ã«1ã¤ã§ã‚‚æ‰€æŒã—ãŸè¨˜éŒ²(maxModules)ãŒã‚ã‚Œã°ã€æ—¢èª­(seen)ã«ã™ã‚‹
        if (game.stats.maxModules[k] > 0) {
            game.seenModules[k] = true;
        }
    }
}
function loadGame() {
    const save = localStorage.getItem('neoEvoSaveV16');
    if(save) {
        try { fixGameData(JSON.parse(save)); } catch(e) { console.error("Save Load Error", e); }
    }
}
// â˜…è¿½åŠ : ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’ä¿å­˜ã™ã‚‹é–¢æ•°
function saveScrollPositions() {
    // ã‚¿ãƒ–ã®çŠ¶æ…‹ä¿å­˜
    document.querySelectorAll('.tab-content').forEach(c => {
        if(c.style.display === 'block') {
            tabScrollStates[c.id] = c.scrollTop;
        }
    });

    const scrollData = {};
    
    // â–  å·¦å´ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒªã‚¹ãƒˆï¼šãƒ”ã‚¯ã‚»ãƒ«ã§ã¯ãªãã€Œä¸€ç•ªä¸Šã«è¦‹ãˆã¦ã„ã‚‹è¦ç´ ã€ã‚’è¨˜éŒ²ã™ã‚‹
    const upgradeList = document.getElementById('upgrade-list');
    if(upgradeList) {
        scrollData['upgrade-list-px'] = upgradeList.scrollTop; // ä¿é™ºã¨ã—ã¦ãƒ”ã‚¯ã‚»ãƒ«ã‚‚ä¿å­˜
        
        const currentScroll = upgradeList.scrollTop;
        const children = Array.from(upgradeList.children);
        
        // è¦‹ãˆã¦ã„ã‚‹ä¸€ç•ªä¸Šã®è¦ç´ ã‚’æ¢ã™
        for(let child of children) {
            if(child.style.display === 'none') continue;
            // è¦ç´ ã®ä¸‹ç«¯ãŒã€ç¾åœ¨ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚ˆã‚Šä¸‹ã«ã‚ã‚Œã°ã€ãã‚ŒãŒã€Œç¾åœ¨è¦‹ãˆã¦ã„ã‚‹ä¸€ç•ªä¸Šã®è¦ç´ ã€
            if (child.offsetTop + child.offsetHeight > currentScroll) {
                scrollData['upgrade-anchor'] = { 
                    id: child.id, 
                    offset: currentScroll - child.offsetTop // è¦ç´ ã®é ­ã‹ã‚‰ä½•ãƒ”ã‚¯ã‚»ãƒ«ãšã‚Œã¦ã„ã‚‹ã‹
                };
                break;
            }
        }
    }
    
    // å³å´ã®å„ã‚¿ãƒ–
    scrollData['tabStates'] = tabScrollStates;

    // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚¿ãƒ–ID
    const activeBtn = document.querySelector('.tab-btn.active');
    if(activeBtn) scrollData['activeTabId'] = activeBtn.id;

    sessionStorage.setItem('neoEvoScrollState', JSON.stringify(scrollData));
}

// â˜…ä¿®æ­£: ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’å¾©å…ƒã™ã‚‹é–¢æ•°ï¼ˆè£œæ­£å¼·åŒ–ç‰ˆï¼‰
function restoreScrollPositions() {
    const data = sessionStorage.getItem('neoEvoScrollState');
    if(!data) return;

    try {
        const scrollData = JSON.parse(data);
        
        // ã‚¿ãƒ–ã®å¾©å…ƒ
        if(scrollData.activeTabId) {
            const btn = document.getElementById(scrollData.activeTabId);
            if(btn) {
                let tabName = 'system';
                if(btn.id.includes('artifacts')) tabName = 'artifacts';
                else if(btn.id.includes('challenges')) tabName = 'challenges';
                else if(btn.id.includes('transcend')) tabName = 'transcend';
                switchTab(tabName, btn);
            }
        }

        // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’é©ç”¨ã™ã‚‹å†…éƒ¨é–¢æ•°
        const applyScroll = () => {
            // â–  å·¦å´ãƒªã‚¹ãƒˆã®å¾©å…ƒï¼ˆã‚¢ãƒ³ã‚«ãƒ¼æ–¹å¼ï¼‰
            const uList = document.getElementById('upgrade-list');
            if(uList) {
                // ã‚¢ãƒ³ã‚«ãƒ¼æƒ…å ±ãŒã‚ã‚Œã°ãã‚Œã‚’ä½¿ã£ã¦ä½ç½®åˆã‚ã›
                if (scrollData['upgrade-anchor'] && scrollData['upgrade-anchor'].id) {
                    const anchorId = scrollData['upgrade-anchor'].id;
                    const offset = scrollData['upgrade-anchor'].offset || 0;
                    const anchorEl = document.getElementById(anchorId);
                    
                    if (anchorEl) {
                        uList.scrollTop = anchorEl.offsetTop + offset;
                    }
                } else if (scrollData['upgrade-list-px']) {
                    // ã‚¢ãƒ³ã‚«ãƒ¼ãŒãªã„å ´åˆã¯ãƒ”ã‚¯ã‚»ãƒ«å€¤ï¼ˆä¿é™ºï¼‰
                    uList.scrollTop = scrollData['upgrade-list-px'];
                }
            }

            // â–  å³å´ã‚¿ãƒ–ã®å¾©å…ƒ
            if(scrollData['tabStates']) {
                tabScrollStates = scrollData['tabStates'];
                // ç¾åœ¨è¡¨ç¤ºä¸­ã®ã‚¿ãƒ–ã«ã‚‚å³é©ç”¨
                document.querySelectorAll('.tab-content').forEach(c => {
                    if(c.style.display === 'block' && tabScrollStates[c.id] !== undefined) {
                        c.scrollTop = tabScrollStates[c.id];
                    }
                });
            }
        };

        // â˜…é‡è¦: ãƒ•ã‚©ãƒ³ãƒˆèª­ã¿è¾¼ã¿ã‚„ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆç¢ºå®šã®ã‚ºãƒ¬ã‚’é˜²ããŸã‚ã€
        // ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’å¤‰ãˆã¦3å›å®Ÿè¡Œã—ã€ä½ç½®ã‚’å¼·åˆ¶çš„ã«åˆã‚ã›ã‚‹
        applyScroll(); // å³æ™‚
        setTimeout(applyScroll, 50);  // 50mså¾Œ
        setTimeout(() => {
            applyScroll();            // 200mså¾Œï¼ˆæœ€çµ‚ç¢ºå®šï¼‰
            sessionStorage.removeItem('neoEvoScrollState');
        }, 200);

    } catch(e) {
        console.error("Scroll Restore Error", e);
    }
}

function resetSave() { if(confirm("ãƒ‡ãƒ¼ã‚¿ã‚’å®Œå…¨ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) { localStorage.removeItem('neoEvoSaveV16'); location.reload(); } }
document.addEventListener('DOMContentLoaded', init);
/* =========================================
    SKIN MENU CONTROLS
   ========================================= */
function toggleSkinModal(show) {
    const modal = document.getElementById('skin-modal');
    if (!modal) return;
    modal.style.display = show ? 'flex' : 'none';
    if(show) {
        const lang = game.settings.lang || 'ja';
        const L = LANG_DATA[lang];
        const colorSelect = document.getElementById('skin-color-select');
        const shapeSelect = document.getElementById('skin-shape-select');
        
        // â˜…ä¿®æ­£ï¼šè¨€èªè¨­å®šã«åˆã‚ã›ã¦åå‰ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹
        const labelAuto = (lang === 'ja') ? "ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ" : "Default";
        
        // ã‚«ãƒ©ãƒ¼é¸æŠè‚¢ã®ç”Ÿæˆ
        let colorOptions = `<option value="auto" ${game.skinSettings.manualColor === 'auto' ? 'selected' : ''}>${labelAuto}</option>`;
        colorOptions += STAGE_DEFS.map((d, i) => {
            const displayName = (lang === 'ja') ? d.name_ja : d.name;
            return `<option value="${i}" ${game.skinSettings.manualColor == i ? 'selected' : ''}>${displayName}</option>`;
        }).join('');
        colorSelect.innerHTML = colorOptions;

        // å½¢çŠ¶é¸æŠè‚¢ã®ç”Ÿæˆ
        let shapeOptions = `<option value="auto" ${game.skinSettings.manualShape === 'auto' ? 'selected' : ''}>${labelAuto}</option>`;
        shapeOptions += CYCLE_SHAPE_CLASSES.map((s, i) => `<option value="${i}" ${game.skinSettings.manualShape == i ? 'selected' : ''}>Stage ${i+1}</option>`).join('');
        shapeSelect.innerHTML = shapeOptions;
    }
}

function updateManualSkin() {
    const colorVal = document.getElementById('skin-color-select').value;
    const shapeVal = document.getElementById('skin-shape-select').value;
    
    // 'auto' ã®å ´åˆã¯æ–‡å­—åˆ—ã®ã¾ã¾ä¿å­˜ã—ã€ãã‚Œä»¥å¤–ã¯æ•°å€¤ã¨ã—ã¦ä¿å­˜
    game.skinSettings.manualColor = (colorVal === 'auto') ? 'auto' : parseInt(colorVal);
    game.skinSettings.manualShape = (shapeVal === 'auto') ? 'auto' : parseInt(shapeVal);
    
    updateStageConfig(true);
    updateUI();
}
</script>
<script>
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', function() {
            navigator.serviceWorker.register('sw.js').then(function(registration) {
                console.log('ServiceWorker registration successful');
            }, function(err) {
                console.log('ServiceWorker registration failed: ', err);
            });
        });
    }
</script>
</body>
</html>





